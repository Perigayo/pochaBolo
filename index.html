<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>POCHA ULTIMATE 2026</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --bg: #064e3b; --gold: #fbbf24; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: sans-serif; margin: 0; padding: 0; }
        body, html { height: 100%; overflow: hidden; background: var(--bg); color: white; font-family: system-ui, -apple-system, sans-serif; }
        .safe-area { padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom); height: 100%; display: flex; flex-direction: column; }
        .glass { background: rgba(0,0,0,0.85); backdrop-filter: blur(12px); border-radius: 24px; border: 1px solid rgba(255,255,255,0.1); }
        
        .card { width: 52px; height: 78px; background: white; border-radius: 8px; color: black; display: flex; flex-direction: column; justify-content: space-between; padding: 5px; font-weight: 900; box-shadow: 0 4px 10px rgba(0,0,0,0.4); border: 1px solid #ddd; }
        .card-active:active { transform: translateY(-15px) scale(1.1); border: 2px solid var(--gold); }
        .card.disabled { opacity: 0.3; filter: grayscale(1); pointer-events: none; }
        
        .table-zone { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; width: 100%; }
        .played-card-container { position: absolute; display: flex; flex-direction: column; align-items: center; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .player-label { background: rgba(0,0,0,0.7); padding: 2px 8px; border-radius: 10px; font-size: 9px; font-weight: 900; text-transform: uppercase; margin-bottom: 4px; border: 1px solid rgba(255,255,255,0.2); white-space: nowrap; }

        .btn-gold { background: var(--gold); color: black; font-weight: 900; border-radius: 18px; padding: 18px; text-transform: uppercase; }
        .btn-gold:disabled { background: #444; color: #888; cursor: not-allowed; }
        .btn-admin { background: #ffffff; color: #000000; font-weight: 900; border-radius: 50px; padding: 14px 28px; box-shadow: 0 10px 20px rgba(0,0,0,0.4); border: 2px solid var(--gold); }
        
        .suits { font-size: 24px; text-align: center; }
    </style>
</head>
<body>

<div class="safe-area">
    <div id="screen-menu" class="h-full flex flex-col items-center justify-center space-y-8">
        <div class="text-center">
            <h1 class="text-6xl font-black italic text-yellow-500 tracking-tighter">POCHA</h1>
            <p class="text-yellow-500/50 font-bold tracking-[0.3em] text-[10px]">BOLO 2026</p>
        </div>
        <div class="w-full max-w-xs space-y-4">
            <button onclick="show('online-setup')" class="btn-gold w-full text-lg shadow-lg">üåê Juego Online</button>
            <button onclick="show('bolo-setup')" class="w-full py-4 glass font-bold text-zinc-400">üìù Marcador Bolo</button>
        </div>
    </div>

    <div id="screen-online-setup" class="hidden h-full flex flex-col justify-center p-4">
        <div class="glass p-8 space-y-6">
            <input type="text" id="p-name" placeholder="TU NOMBRE" class="w-full p-4 rounded-2xl bg-black/40 border border-white/10 uppercase font-bold text-center outline-none">
            <input type="text" id="p-room" placeholder="C√ìDIGO MESA" class="w-full p-4 rounded-2xl bg-black/40 border border-white/10 uppercase font-bold text-center text-yellow-500 outline-none">
            <button onclick="initOnline()" class="btn-gold w-full">Entrar</button>
            <button onclick="show('menu')" class="w-full text-xs opacity-40 font-bold py-2">Cancelar</button>
        </div>
    </div>

    <div id="screen-game" class="hidden h-full flex flex-col">
        <div class="flex justify-between items-center py-3 px-2 z-50">
            <div id="ui-room" class="bg-black/60 px-4 py-1.5 rounded-full text-[10px] font-black border border-white/10 uppercase"></div>
            <div id="ui-trump" class="scale-90 origin-right"></div>
        </div>
        <div class="table-zone">
            <div id="ui-scores" class="absolute top-2 left-2 glass p-3 text-[9px] z-50 min-w-[120px] border-l-4 border-yellow-500"></div>
            <div id="table-cards" class="relative w-full h-full flex items-center justify-center"></div>
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <div id="ui-status-container" class="pointer-events-auto flex flex-col items-center gap-2"></div>
            </div>
        </div>
        <div class="pb-8"><div id="ui-hand" class="flex justify-center gap-2 overflow-x-auto py-4 px-4 min-h-[120px]"></div></div>
    </div>

    <div id="screen-bolo-setup" class="hidden h-full flex flex-col p-6 justify-center">
        <div class="glass p-6 space-y-4">
            <h2 class="text-xl font-black text-center text-yellow-500 uppercase italic">Jugadores Bolo</h2>
            <div class="flex gap-2">
                <input type="text" id="bolo-new-p" class="flex-1 p-4 bg-black/40 rounded-xl border border-white/10 font-bold uppercase outline-none">
                <button onclick="addBoloP()" class="bg-yellow-600 px-6 rounded-xl font-black text-2xl">+</button>
            </div>
            <div id="bolo-list" class="space-y-2 max-h-48 overflow-y-auto"></div>
            <button id="btn-bolo-start" onclick="startBolo()" class="hidden btn-gold w-full">Empezar</button>
            <button onclick="show('menu')" class="w-full text-xs opacity-40 font-bold">Volver</button>
        </div>
    </div>

    <div id="screen-bolo-board" class="hidden h-full flex flex-col py-6 px-4">
        <div class="glass p-4 text-center mb-4 border-b-4 border-yellow-500">
            <p id="bolo-info" class="text-[10px] font-bold text-yellow-500 uppercase"></p>
            <h2 id="bolo-cards" class="text-6xl font-black italic">--</h2>
        </div>
        <div class="flex-1 glass p-4 overflow-y-auto space-y-4" id="bolo-inputs"></div>
        <div id="bolo-rule" class="hidden bg-red-600/30 text-red-100 p-3 rounded-xl text-center mb-2 italic border border-red-500">
            ‚ö†Ô∏è REGLA: El postre no puede pedir <span id="bolo-forbid" class="font-black text-white text-xl"></span>
        </div>
        <button id="btn-bolo-next" onclick="nextBolo()" class="btn-gold w-full py-5 text-xl">Confirmar</button>
    </div>

    <div id="modal-rank" class="hidden fixed inset-0 z-[300] bg-black/98 flex items-center justify-center p-4 text-center">
        <div class="glass w-full max-w-xs p-8 border-2 border-yellow-500/20">
            <h2 class="text-3xl font-black text-yellow-500 italic mb-6 uppercase">Marcador</h2>
            <div id="rank-content" class="space-y-3 mb-8"></div>
            <button id="rank-btn-admin" class="btn-gold w-full">Avanzar Ronda</button>
            <div id="rank-wait" class="text-xs font-bold opacity-40 animate-pulse uppercase">Esperando...</div>
        </div>
    </div>

    <div id="modal-bet" class="hidden fixed inset-0 z-[200] bg-black/95 flex items-center justify-center p-6">
        <div class="glass p-8 w-full max-w-md text-center border-t-4 border-yellow-500">
            <div id="bet-trump" class="flex justify-center mb-4"></div>
            <div id="bet-hand" class="flex justify-center gap-1 scale-75 opacity-70 mb-4"></div>
            <p class="text-xs font-black mb-6 uppercase text-yellow-500">¬øCu√°ntas bazas vas a ganar?</p>
            <div id="bet-opts" class="grid grid-cols-4 gap-3"></div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBUXvMwtXc2S_lNghaWOPwvKF5Z7EDB2lQ",
        databaseURL: "https://pochaonline-ebbc1-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "pochaonline-ebbc1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let state = null;
    let myName = "";
    let roomCode = "";
    let bolo = { players: [], round: 0, betting: true, dealerIdx: 0 };
    const suits = { 'OROS': 'üü°', 'COPAS': 'üç∑', 'ESPADAS': '‚öîÔ∏è', 'BASTOS': 'ü™µ' };

    function show(id) {
        document.querySelectorAll('.safe-area > div').forEach(d => d.classList.add('hidden'));
        document.getElementById('screen-' + id).classList.remove('hidden');
    }

    // --- L√ìGICA ONLINE ---
    async function initOnline() {
        myName = document.getElementById('p-name').value.trim().toUpperCase();
        roomCode = document.getElementById('p-room').value.trim().toUpperCase();
        if(!myName || !roomCode) return;
        const ref = db.ref('rooms/' + roomCode);
        const snap = await ref.get();
        let data = snap.val() || { players: [], phase: 'LOBBY', round: 0, turn: 0 };
        if(!data.players.find(p => p.name === myName)) {
            data.players.push({ name: myName, score: 0, lastDiff: 0, bet: -1, made: 0, hand: [], played: null });
            await ref.set(data);
        }
        ref.on('value', s => { state = s.val(); if(state) renderOnline(); });
        show('game');
    }

    function renderOnline() {
        const isAdmin = state.players[0].name === myName;
        const me = state.players.find(p => p.name === myName);
        const isTurn = state.players[state.turn]?.name === myName;
        const nCards = getSeq(state.players.length)[state.round];

        document.getElementById('ui-room').innerText = `R-${state.round + 1} | SALA ${roomCode}`;
        document.getElementById('ui-trump').innerHTML = state.trump ? cardUI(state.trump, 'small') : '';
        document.getElementById('ui-scores').innerHTML = state.players.map(p => `<div class="mb-1 ${state.players[state.turn]?.name === p.name ? 'text-yellow-400 font-bold' : 'opacity-40'}">${p.name}: ${p.score} <span class="float-right">[${p.made}/${p.bet < 0 ? '?' : p.bet}]</span></div>`).join('');

        const statusCont = document.getElementById('ui-status-container');
        if(state.phase === 'LOBBY') {
            statusCont.innerHTML = isAdmin ? `<button onclick="deal()" class="btn-admin text-xs">REPARTIR ${nCards}</button>` : `<div class="glass px-6 py-2 text-[9px] uppercase">Esperando al Host...</div>`;
        } else if(state.phase === 'RESOLVING') {
            statusCont.innerHTML = `<div class="flex flex-col items-center gap-3">
                <div class="bg-blue-600 text-white px-6 py-2 rounded-full font-black text-[10px] uppercase">¬°${state.winnerName} se la lleva!</div>
                ${isAdmin ? `<button onclick="resolveBaza()" class="btn-admin text-xs">LIMPIAR MESA</button>` : ''}
            </div>`;
        } else {
            statusCont.innerHTML = `<div class="bg-yellow-500 text-black px-6 py-2 rounded-full font-black text-[10px] uppercase shadow-xl">${isTurn ? '¬°TE TOCA!' : 'TURNO: ' + state.players[state.turn].name}</div>`;
        }

        const table = document.getElementById('table-cards'); table.innerHTML = "";
        state.players.forEach((p, i) => {
            if(p.played) {
                const angle = (i * (360 / state.players.length)) - 90;
                const div = document.createElement('div');
                div.className = "played-card-container";
                div.style.transform = `rotate(${angle}deg) translate(80px) rotate(-${angle}deg)`;
                div.innerHTML = `<div class="player-label ${p.name === myName ? 'text-yellow-400 border-yellow-400' : ''}">${p.name}</div>` + cardUI(p.played);
                table.appendChild(div);
            }
        });

        const handUI = document.getElementById('ui-hand'); handUI.innerHTML = "";
        if(me && me.hand) {
            const hasSuit = me.hand.some(c => c.s === state.firstSuit);
            me.hand.forEach((c, idx) => {
                const canPlay = state.phase === 'PLAYING' && isTurn && (!state.firstSuit || c.s === state.firstSuit || !hasSuit);
                const el = document.createElement('div');
                el.innerHTML = cardUI(c, 'normal', !canPlay && state.phase === 'PLAYING');
                if(canPlay) el.onclick = () => playCard(idx);
                handUI.appendChild(el);
            });
        }

        if(state.phase === 'BETTING' && isTurn) {
            const mBet = document.getElementById('modal-bet'); mBet.classList.remove('hidden');
            document.getElementById('bet-trump').innerHTML = cardUI(state.trump);
            document.getElementById('bet-hand').innerHTML = me.hand.map(c => cardUI(c, 'small')).join('');
            const opts = document.getElementById('bet-opts'); opts.innerHTML = "";
            const done = state.players.filter(p => p.bet !== -1).length;
            const sum = state.players.reduce((a, b) => a + (b.bet === -1 ? 0 : b.bet), 0);
            const forbid = (done === state.players.length - 1) ? (nCards - sum) : -1;
            for(let i=0; i<=nCards; i++) {
                const btn = document.createElement('button');
                btn.className = `p-4 rounded-xl font-black ${i === forbid ? 'bg-zinc-800 text-zinc-600' : 'bg-yellow-500 text-black'}`;
                btn.innerText = i; btn.disabled = (i === forbid);
                btn.onclick = () => db.ref(`rooms/${roomCode}`).update({
                    [`players/${state.turn}/bet`]: i, turn: (state.turn + 1) % state.players.length,
                    phase: (done + 1 === state.players.length) ? 'PLAYING' : 'BETTING'
                });
                opts.appendChild(btn);
            }
        } else document.getElementById('modal-bet').classList.add('hidden');

        const mRank = document.getElementById('modal-rank');
        if(state.phase === 'RANKING') {
            mRank.classList.remove('hidden');
            document.getElementById('rank-content').innerHTML = [...state.players].sort((a,b)=>b.score-a.score).map(p => `<div class="flex justify-between font-black items-center border-b border-white/5 pb-2"><span>${p.name}</span><span>${p.score} (${p.lastDiff >= 0 ? '+' : ''}${p.lastDiff})</span></div>`).join('');
            document.getElementById('rank-btn-admin').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('rank-wait').style.display = isAdmin ? 'none' : 'block';
            document.getElementById('rank-btn-admin').onclick = () => db.ref(`rooms/${roomCode}`).update({ phase: 'LOBBY' });
        } else mRank.classList.add('hidden');
    }

    async function playCard(idx) {
        let ps = [...state.players];
        let card = ps[state.turn].hand.splice(idx, 1)[0];
        ps[state.turn].played = card;
        let fs = state.firstSuit || card.s;
        let t = (state.turn + 1) % ps.length;
        let ph = ps.every(p => p.played) ? 'RESOLVING' : 'PLAYING';
        let winN = "";
        if(ph === 'RESOLVING') {
            let winI = 0; let best = -1;
            ps.forEach((p, i) => {
                let v = p.played.v === 1 ? 20 : (p.played.v === 3 ? 15 : p.played.v);
                let pwr = (p.played.s === state.trump.s) ? v + 100 : (p.played.s === fs ? v : 0);
                if(pwr > best) { best = pwr; winI = i; }
            });
            winN = ps[winI].name;
        }
        await db.ref(`rooms/${roomCode}`).update({ players: ps, firstSuit: fs, turn: t, phase: ph, winnerName: winN });
    }

    async function resolveBaza() {
        let ps = [...state.players];
        let winI = 0; let best = -1;
        ps.forEach((p, i) => {
            let v = p.played.v === 1 ? 20 : (p.played.v === 3 ? 15 : p.played.v);
            let pwr = (p.played.s === state.trump.s) ? v + 100 : (p.played.s === state.firstSuit ? v : 0);
            if(pwr > best) { best = pwr; winI = i; }
        });
        ps[winI].made++; ps.forEach(p => p.played = null);
        let endR = ps[0].hand.length === 0;
        let up = { players: ps, turn: winI, firstSuit: null, phase: 'PLAYING' };
        if(endR) {
            ps.forEach(p => {
                let d = (p.bet === p.made) ? (10 + p.made * 5) : -5;
                p.score += d; p.lastDiff = d; p.bet = -1; p.made = 0;
            });
            up.round = state.round + 1; up.phase = 'RANKING';
        }
        await db.ref(`rooms/${roomCode}`).update(up);
    }

    async function deal() {
        const n = getSeq(state.players.length)[state.round];
        const deck = [];
        ['OROS','COPAS','ESPADAS','BASTOS'].forEach(s => [1,2,3,4,5,6,7,10,11,12].forEach(v => deck.push({s,v})));
        deck.sort(() => Math.random() - 0.5);
        let ps = state.players.map(p => ({ ...p, hand: deck.splice(0, n), bet: -1, made: 0, played: null }));
        await db.ref(`rooms/${roomCode}`).update({ players: ps, trump: deck.pop(), phase: 'BETTING', turn: state.round % ps.length, firstSuit: null });
    }

    // --- MARCADOR BOLO ---
    function addBoloP() { const v = document.getElementById('bolo-new-p').value.trim().toUpperCase(); if(v) { bolo.players.push({ name: v, score: 0, bet: 0, lastDiff: 0 }); document.getElementById('bolo-new-p').value = ""; renderBoloList(); } }
    function renderBoloList() { document.getElementById('bolo-list').innerHTML = bolo.players.map((p, i) => `<div class="flex justify-between p-4 glass font-bold"><span>${p.name}</span><button onclick="bolo.players.splice(${i},1);renderBoloList()">BORRAR</button></div>`).join(''); document.getElementById('btn-bolo-start').classList.toggle('hidden', bolo.players.length < 2); }
    function startBolo() { bolo.round = 0; bolo.betting = true; bolo.dealerIdx = 0; show('bolo-board'); updateBoloUI(); }
    
    function updateBoloUI() {
        const nCards = getSeq(bolo.players.length)[bolo.round];
        document.getElementById('bolo-info').innerText = `RONDA ${bolo.round + 1}`;
        document.getElementById('bolo-cards').innerText = nCards;
        const area = document.getElementById('bolo-inputs'); area.innerHTML = "";
        let order = [];
        for(let i=0; i<bolo.players.length; i++) order.push((bolo.dealerIdx + 1 + i) % bolo.players.length);

        order.forEach((idx, i) => {
            const p = bolo.players[idx];
            const isLast = (i === bolo.players.length - 1);
            const div = document.createElement('div');
            div.className = "flex justify-between items-center p-4 glass " + (isLast ? "border-l-4 border-red-500" : "");
            div.innerHTML = `
                <div class="flex flex-col">
                    <span class="font-black text-xs uppercase">${p.name}</span>
                    <span class="text-[8px] opacity-50 font-bold">${isLast ? 'POSTRE' : 'PIDE'}</span>
                    ${!bolo.betting ? `<span class="text-[10px] text-yellow-500 font-black">PIDI√ì: ${p.bet}</span>` : ''}
                </div>
                <input type="number" id="bi-${idx}" class="w-16 p-3 bg-black rounded-xl text-center font-black" oninput="checkBoloRule()">
            `;
            area.appendChild(div);
        });
        checkBoloRule();
    }

    function checkBoloRule() {
        if (!bolo.betting) { document.getElementById('btn-bolo-next').disabled = false; document.getElementById('bolo-rule').classList.add('hidden'); return; }
        const nCards = getSeq(bolo.players.length)[bolo.round];
        const lastPlayerIdx = bolo.dealerIdx;
        let sum = 0; let playersDone = 0;

        bolo.players.forEach((p, i) => {
            const val = parseInt(document.getElementById(`bi-${i}`).value);
            if (i !== lastPlayerIdx && !isNaN(val)) { sum += val; playersDone++; }
        });

        if (playersDone === bolo.players.length - 1) {
            const forbidden = nCards - sum;
            const lastVal = parseInt(document.getElementById(`bi-${lastPlayerIdx}`).value);
            if (forbidden >= 0 && forbidden <= nCards) {
                document.getElementById('bolo-rule').classList.remove('hidden');
                document.getElementById('bolo-forbid').innerText = forbidden;
                document.getElementById('btn-bolo-next').disabled = (lastVal === forbidden || isNaN(lastVal));
            } else {
                document.getElementById('bolo-rule').classList.add('hidden');
                document.getElementById('btn-bolo-next').disabled = isNaN(lastVal);
            }
        } else {
            document.getElementById('bolo-rule').classList.add('hidden');
            document.getElementById('btn-bolo-next').disabled = true;
        }
    }

    function nextBolo() {
        if(bolo.betting) {
            bolo.players.forEach((p, i) => p.bet = parseInt(document.getElementById(`bi-${i}`).value) || 0);
            bolo.betting = false; updateBoloUI();
        } else {
            bolo.players.forEach((p, i) => { 
                const m = parseInt(document.getElementById(`bi-${i}`).value) || 0; 
                let d = (m === p.bet) ? (10 + m * 5) : -5;
                p.score += d; p.lastDiff = d;
            });
            document.getElementById('rank-content').innerHTML = [...bolo.players].sort((a,b)=>b.score-a.score).map(p => `<div class="flex justify-between font-black"><span>${p.name}</span><span>${p.score} (${p.lastDiff >= 0 ? '+' : ''}${p.lastDiff})</span></div>`).join('');
            document.getElementById('modal-rank').classList.remove('hidden');
            document.getElementById('rank-btn-admin').style.display = 'block';
            document.getElementById('rank-btn-admin').onclick = () => {
                document.getElementById('modal-rank').classList.add('hidden');
                bolo.round++;
                bolo.dealerIdx = (bolo.dealerIdx + 1) % bolo.players.length;
                bolo.betting = true; updateBoloUI();
            };
        }
    }

    function cardUI(c, mode='normal', off=false) {
        const v = c.v === 1 ? 'A' : c.v;
        return `<div class="card ${mode==='small'?'scale-75':''} ${off?'disabled':'card-active'}"><div class="leading-none text-[10px]">${v}</div><div class="suits">${suits[c.s]}</div><div class="leading-none text-[10px] self-end rotate-180">${v}</div></div>`;
    }
    
    function getSeq(nP) {
        let s = []; const max = Math.floor(40/nP);
        for(let i=0;i<nP;i++) s.push(1); for(let i=2;i<max;i++) s.push(i);
        for(let i=0;i<nP;i++) s.push(max); for(let i=max-1;i>=2;i--) s.push(i);
        for(let i=0;i<nP;i++) s.push(1); return s;
    }
</script>
</body>
</html>