<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pocha Master Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #064e3b; color: white; font-family: sans-serif; overflow: hidden; margin: 0; position: fixed; width: 100%; height: 100%; }
        .glass { background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .card { width: 58px; height: 85px; background-color: white !important; color: black !important; border-radius: 8px; display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding: 5px; font-weight: 900; box-shadow: 0 4px 10px rgba(0,0,0,0.5); border: 1px solid #ddd; }
        .table-center { background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 75%); border-radius: 50%; width: 220px; height: 220px; position: absolute; top: 42%; left: 50%; transform: translate(-50%, -50%); border: 1px dashed rgba(255,255,255,0.2); }
        .played-card { position: absolute; transform-origin: center; left: 50%; top: 50%; margin-left: -29px; margin-top: -42px; z-index: 10; }
        .card-active { border: 3px solid #fbbf24 !important; transform: translateY(-15px); cursor: pointer; transition: transform 0.2s; }
        #winner-notif { pointer-events: none; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); opacity: 0; transform: translate(-50%, -40%) scale(0.5); position: fixed; top: 50%; left: 50%; z-index: 500; }
        #winner-notif.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        .input-dark { background: #1a1a1a; border: 1px solid #444; color: white; border-radius: 12px; }
    </style>
</head>
<body>

    <div id="main-menu" class="flex flex-col items-center justify-center h-screen space-y-6 bg-[#064e3b] px-6 text-center z-[500] relative">
        <h1 class="text-5xl font-black text-yellow-500 italic uppercase">LA POCHA</h1>
        <div class="text-7xl">üçè</div>
        <div class="w-full max-w-xs space-y-4">
            <button onclick="showScreen('online-lobby')" class="w-full bg-blue-600 p-5 rounded-2xl font-black text-xl shadow-lg uppercase">üåê Juego Online</button>
            <button onclick="showScreen('score-setup')" class="w-full bg-zinc-800 p-5 rounded-2xl font-black text-xl shadow-lg uppercase border border-white/10">üìù Marcador BOLO</button>
        </div>
    </div>

    <div id="online-game-screen" class="hidden h-screen flex flex-col p-4 relative overflow-hidden">
        <div class="flex justify-between items-start z-[160]">
            <div id="online-scores" class="glass p-3 rounded-xl text-[10px] min-w-[110px] border-l-4 border-yellow-500"></div>
            <div id="trump-slot" class="scale-90"></div>
        </div>
        <div class="table-center" id="board"></div>
        <div id="winner-notif" class="glass px-8 py-4 rounded-3xl border-2 border-yellow-500 text-center min-w-[200px]">
            <p class="text-yellow-500 font-bold uppercase text-[10px]">¬°Baza para!</p>
            <h2 id="winner-name-msg" class="text-3xl font-black italic text-white uppercase">---</h2>
        </div>
        <div class="absolute top-[62%] left-0 w-full text-center z-20">
            <p id="status-msg" class="text-yellow-400 font-black uppercase text-sm drop-shadow-md bg-black/40 px-6 py-2 inline-block rounded-full border border-yellow-500/30"></p>
        </div>
        <div class="mt-auto flex justify-center gap-1 pb-10" id="player-hand" style="min-height: 120px;"></div>
    </div>

    <div id="score-setup" class="hidden min-h-screen p-6 max-w-md mx-auto">
        <button onclick="location.reload()" class="text-gray-400 font-bold uppercase text-xs">‚Üê Volver</button>
        <h2 class="text-3xl font-black text-yellow-500 my-6 italic text-center uppercase">MARCADOR BOLO</h2>
        <div class="glass p-6 rounded-3xl space-y-4">
            <input type="text" id="p-name-bolo" class="w-full p-4 input-dark font-bold uppercase" placeholder="Nombre...">
            <button onclick="addPlayerBolo()" class="w-full bg-yellow-600 py-4 rounded-xl font-bold uppercase">A√±adir Jugador</button>
            <ul id="p-list-bolo" class="space-y-2 border-l-2 border-yellow-500 pl-4"></ul>
            <button onclick="startGameBolo()" id="btn-start-bolo" class="hidden w-full bg-green-700 py-4 rounded-2xl font-black uppercase">Empezar Partida</button>
        </div>
    </div>

    <div id="bet-modal" class="hidden fixed inset-0 z-[150] flex flex-col items-center pt-20 bg-black/60">
        <div id="bet-container" class="glass p-5 rounded-3xl text-center border-b-4 border-yellow-500 w-[85%] max-w-xs">
            <h2 id="bet-player-name" class="text-xl font-black mb-4 text-white uppercase">---</h2>
            <div id="bet-options" class="flex flex-wrap justify-center gap-2"></div>
            <p id="online-forbidden-msg" class="text-red-500 text-[10px] font-bold mt-4 uppercase hidden italic">‚ö†Ô∏è Prohibido pedir <span id="online-forbidden-val"></span></p>
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN (Usa la tuya de Firebase)
        const firebaseConfig = {
            apiKey: "AIzaSyBUXvMwtXc2S_lNghaWOPwvKF5Z7EDB2lQ",
            authDomain: "pochaonline-ebbc1.firebaseapp.com",
            databaseURL: "https://pochaonline-ebbc1-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "pochaonline-ebbc1"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myName = ""; let roomCode = ""; let roomRef = null; let gameState = null;
        const emojis = {'OROS': 'üü°', 'COPAS': 'üç∑', 'ESPADAS': '‚öîÔ∏è', 'BASTOS': 'ü™µ'};

        function showScreen(id) {
            document.querySelectorAll('body > div').forEach(div => div.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            if(id === 'online-lobby') initOnline();
        }

        function generatePochaSeq(nP, total) {
            let s = []; const max = Math.floor(total / nP);
            for(let i=0; i<nP; i++) s.push(1);
            for(let i=2; i<max; i++) s.push(i);
            for(let i=0; i<nP; i++) s.push(max);
            for(let i=max-1; i>=2; i--) s.push(i);
            for(let i=0; i<nP; i++) s.push(1);
            return s;
        }

        /* --- L√ìGICA ONLINE MEJORADA --- */
        function initOnline() {
            myName = prompt("TU NOMBRE:").toUpperCase();
            roomCode = prompt("C√ìDIGO SALA:").toUpperCase();
            if(!myName || !roomCode) return location.reload();
            roomRef = db.ref('rooms/' + roomCode);
            roomRef.on('value', snap => {
                gameState = snap.val();
                if(gameState) renderOnline();
            });
            roomRef.once('value', snap => {
                let d = snap.val() || { players: [], roundIdx: 0, turn: 0, phase: 'LOBBY', cardsPlayed: 0 };
                if(!d.players.find(p => p.name === myName)) {
                    d.players.push({ name: myName, score: 0, bet: -1, made: 0, hand: [] });
                }
                roomRef.set(d);
            });
            showScreen('online-game-screen');
        }

        function renderOnline() {
            const me = gameState.players.find(p => p.name === myName);
            const activeP = gameState.players[gameState.turn];
            const myTurn = (activeP && activeP.name === myName);
            const seq = generatePochaSeq(gameState.players.length, 40);
            const currentCards = seq[gameState.roundIdx] || 1;

            if(gameState.phase === 'LOBBY') {
                document.getElementById('status-msg').innerHTML = gameState.players[0].name === myName ? 
                    `<button onclick="startOnlineRound()" class="bg-green-600 px-6 py-2 rounded-xl pointer-events-auto border-2 font-bold uppercase">Repartir ${currentCards}</button>` : `ESPERANDO AL L√çDER...`;
                return;
            }

            document.getElementById('online-scores').innerHTML = gameState.players.map(p => 
                `<div class="${activeP && p.name===activeP.name?'text-yellow-400 font-bold':''}">${p.name}: ${p.score} [${p.made}/${p.bet<0?'?':p.bet}]</div>`).join('');
            
            const tDiv = document.getElementById('trump-slot'); tDiv.innerHTML = '';
            if(gameState.trump) tDiv.appendChild(createCardUI(gameState.trump));

            const b = document.getElementById('board'); b.innerHTML = '';
            gameState.players.forEach((p, i) => {
                if(p.played) {
                    const c = createCardUI(p.played); c.classList.add('played-card');
                    const ang = i * (360 / gameState.players.length);
                    c.style.transform = `rotate(${ang}deg) translateY(-68px) rotate(-${ang}deg)`;
                    b.appendChild(c);
                }
            });

            const h = document.getElementById('player-hand'); h.innerHTML = '';
            if(me.hand) me.hand.forEach((c, i) => {
                const ui = createCardUI(c);
                if(myTurn && gameState.phase === 'PLAYING') { ui.onclick = () => playOnlineCard(i); ui.classList.add('card-active'); }
                h.appendChild(ui);
            });

            const bMod = document.getElementById('bet-modal');
            if(gameState.phase === 'BETTING') {
                bMod.classList.remove('hidden');
                document.getElementById('bet-player-name').innerText = activeP ? activeP.name : "";
                const opts = document.getElementById('bet-options'); opts.innerHTML = '';
                if(myTurn) {
                    const bCount = gameState.players.filter(p => p.bet !== -1).length;
                    const isL = bCount === gameState.players.length - 1;
                    let forbidden = isL ? (currentCards - gameState.players.reduce((a,p)=>a+(p.bet===-1?0:p.bet),0)) : -1;
                    document.getElementById('online-forbidden-msg').classList.toggle('hidden', !(isL && forbidden >= 0));
                    if(isL) document.getElementById('online-forbidden-val').innerText = forbidden;
                    for(let i=0; i<=currentCards; i++) {
                        const btn = document.createElement('button');
                        btn.className = "w-10 h-10 bg-yellow-500 text-black font-black rounded-lg "+(i===forbidden?'opacity-20 pointer-events-none':'');
                        btn.innerText = i; btn.onclick = () => makeOnlineBet(i);
                        opts.appendChild(btn);
                    }
                } else opts.innerHTML = '<p class="text-white opacity-40">Pensando apuesta...</p>';
            } else bMod.classList.add('hidden');
        }

        function startOnlineRound() {
            const seq = generatePochaSeq(gameState.players.length, 40);
            const cards = seq[gameState.roundIdx];
            const d = []; ['OROS','COPAS','ESPADAS','BASTOS'].forEach(s => [1,2,3,4,5,6,7,10,11,12].forEach(v => d.push({s,v})));
            d.sort(() => Math.random() - 0.5);
            gameState.players.forEach(p => { 
                p.hand = d.splice(0, cards); 
                p.bet = -1; p.made = 0; p.played = false; 
            });
            gameState.trump = d.pop(); gameState.phase = 'BETTING'; gameState.turn = 0; gameState.firstSuit = null; gameState.cardsPlayed = 0;
            roomRef.set(gameState);
        }

        function makeOnlineBet(n) {
            gameState.players[gameState.turn].bet = n;
            gameState.turn = (gameState.turn + 1) % gameState.players.length;
            if(gameState.players.every(p => p.bet !== -1)) gameState.phase = 'PLAYING';
            roomRef.set(gameState);
        }

        function playOnlineCard(i) {
            const pIdx = gameState.turn;
            const card = gameState.players[pIdx].hand.splice(i, 1)[0];
            gameState.players[pIdx].played = card;
            if(!gameState.firstSuit) gameState.firstSuit = card.s;
            gameState.cardsPlayed++;
            
            if(gameState.cardsPlayed === gameState.players.length) {
                roomRef.set(gameState).then(() => {
                    setTimeout(resolveOnlineBaza, 1500);
                });
            } else {
                gameState.turn = (gameState.turn + 1) % gameState.players.length;
                roomRef.set(gameState);
            }
        }

        function resolveOnlineBaza() {
            let winIdx = 0; let bestP = -1;
            gameState.players.forEach((p, i) => {
                let v = p.played.v; if(v === 1) v = 20; if(v === 3) v = 15;
                let power = (p.played.s === gameState.trump.s) ? v + 100 : (p.played.s === gameState.firstSuit ? v : 0);
                if(power > bestP) { bestP = power; winIdx = i; }
            });
            
            document.getElementById('winner-name-msg').innerText = gameState.players[winIdx].name;
            document.getElementById('winner-notif').classList.add('show');

            setTimeout(() => {
                document.getElementById('winner-notif').classList.remove('show');
                gameState.players[winIdx].made++;
                gameState.players.forEach(p => p.played = false);
                gameState.turn = winIdx; gameState.firstSuit = null; gameState.cardsPlayed = 0;
                
                const handsEmpty = gameState.players.every(p => !p.hand || p.hand.length === 0);
                if(handsEmpty) {
                    gameState.players.forEach(p => {
                        if(p.bet === p.made) p.score += (10 + p.bet * 5);
                        else p.score -= 5;
                    });
                    gameState.roundIdx++;
                    gameState.phase = 'LOBBY';
                }
                roomRef.set(gameState);
            }, 2000);
        }

        function createCardUI(c) {
            const d = document.createElement('div'); d.className = 'card';
            const val = c.v === 1 ? 'A' : (c.v === 10 ? 'S' : (c.v === 11 ? 'C' : (c.v === 12 ? 'R' : c.v)));
            d.innerHTML = `<div class="text-[10px] self-start leading-none">${val}</div><div class="text-3xl">${emojis[c.s]}</div><div class="text-[10px] self-end rotate-180 leading-none">${val}</div>`;
            return d;
        }

        /* --- MODO BOLO (LOCAL) --- */
        let playersBolo = [];
        function addPlayerBolo() {
            const name = document.getElementById('p-name-bolo').value.toUpperCase();
            if(name) { playersBolo.push(name); document.getElementById('p-list-bolo').innerHTML += `<li class="font-bold">üë§ ${name}</li>`; document.getElementById('p-name-bolo').value = ''; if(playersBolo.length >= 2) document.getElementById('btn-start-bolo').classList.remove('hidden'); }
        }
        function startGameBolo() { alert("Marcador iniciado. Usa la l√≥gica de rondas manual."); }
    </script>
</body>
</html>