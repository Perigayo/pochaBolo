<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pocha Master Pro</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1041/1041883.png">

    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { background-color: #064e3b; color: white; font-family: sans-serif; overflow: hidden; margin: 0; position: fixed; width: 100%; height: 100%; }
        .glass { background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .card { 
            width: 58px; height: 85px; 
            background-color: white !important; 
            color: black !important; 
            border-radius: 8px; 
            display: flex; flex-direction: column; 
            justify-content: space-between; align-items: center; 
            padding: 5px; font-weight: 900; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); 
            border: 1px solid #ddd;
        }
        .table-center { background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 75%); border-radius: 50%; width: 220px; height: 220px; position: absolute; top: 42%; left: 50%; transform: translate(-50%, -50%); border: 1px dashed rgba(255,255,255,0.2); }
        .played-card { position: absolute; transform-origin: center; left: 50%; top: 50%; margin-left: -29px; margin-top: -42px; z-index: 10; }
        .card-active { border: 3px solid #fbbf24 !important; transform: translateY(-15px); cursor: pointer; transition: transform 0.2s; }
        #winner-notif { pointer-events: none; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); opacity: 0; transform: translate(-50%, -40%) scale(0.5); }
        #winner-notif.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        .modal-rank { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 300; padding: 20px; flex-direction: column; align-items: center; justify-content: center; }
        .input-dark { background: #1a1a1a; border: 1px solid #444; color: white; border-radius: 12px; }
    </style>
</head>
<body>

    <div id="main-menu" class="flex flex-col items-center justify-center h-screen space-y-6 bg-[#064e3b] px-6 text-center z-[500] relative">
        <h1 class="text-5xl font-black text-yellow-500 italic uppercase">LA POCHA</h1>
        <div class="text-7xl">üçè</div>
        <div class="w-full max-w-xs space-y-4">
            <button onclick="showScreen('online-lobby')" class="w-full bg-blue-600 p-5 rounded-2xl font-black text-xl shadow-lg uppercase">üåê Juego Online</button>
            <button onclick="showScreen('score-setup')" class="w-full bg-zinc-800 p-5 rounded-2xl font-black text-xl shadow-lg uppercase border border-white/10">üìù Marcador BOLO</button>
        </div>
    </div>

    <div id="score-setup" class="hidden min-h-screen p-6 max-w-md mx-auto">
        <button onclick="location.reload()" class="mb-4 text-gray-400 font-bold uppercase text-xs">‚Üê Volver</button>
        <h2 class="text-3xl font-black text-yellow-500 mb-6 italic uppercase text-center">Configurar BOLO</h2>
        <div class="glass p-6 rounded-3xl space-y-6">
            <div class="flex gap-2">
                <input type="text" id="p-name-bolo" class="flex-1 p-4 input-dark font-bold uppercase" placeholder="Nombre...">
                <button onclick="addPlayerBolo()" class="bg-yellow-600 px-6 rounded-xl font-bold text-2xl">+</button>
            </div>
            <ul id="p-list-bolo" class="space-y-2 italic text-gray-300 border-l-2 border-yellow-600 pl-4"></ul>
            <button onclick="startGameBolo()" id="btn-start-bolo" class="hidden w-full bg-green-700 py-4 rounded-2xl font-black uppercase">Empezar</button>
        </div>
    </div>

    <div id="bolo-game" class="hidden min-h-screen p-4 max-w-md mx-auto">
        <div class="glass p-4 rounded-2xl text-center border-b-4 border-yellow-600 mb-4">
            <p id="b-round-label" class="text-xs text-yellow-500 uppercase font-bold"></p>
            <h2 id="b-cards-label" class="text-5xl font-black text-white"></h2>
        </div>
        <div class="glass p-4 rounded-2xl">
            <h3 id="b-phase-title" class="text-center font-bold mb-4 uppercase text-yellow-500"></h3>
            <div id="b-players-actions" class="space-y-3"></div>
            <p id="b-rule-warning" class="mt-4 text-xs text-red-500 font-bold text-center hidden">‚ö†Ô∏è PROHIBIDO PEDIR <span id="b-forbidden-val"></span></p>
        </div>
        <button id="b-main-btn" onclick="processPhaseBolo()" class="w-full bg-yellow-600 py-5 rounded-2xl font-black text-xl uppercase mt-4">Confirmar</button>
    </div>

    <div id="online-game-screen" class="hidden h-screen flex flex-col p-4 relative overflow-hidden">
        <div class="flex justify-between items-start z-[160]">
            <div id="online-scores" class="glass p-3 rounded-xl text-[10px] min-w-[110px] border-l-4 border-yellow-500"></div>
            <div id="trump-slot" class="scale-90"></div>
        </div>
        <div class="table-center" id="board"></div>
        <div id="winner-notif" class="fixed top-1/2 left-1/2 z-[200] glass px-8 py-4 rounded-3xl border-2 border-yellow-500 text-center min-w-[200px]">
            <p class="text-yellow-500 font-bold uppercase text-[10px]">¬°Baza para!</p>
            <h2 id="winner-name-msg" class="text-3xl font-black italic text-white uppercase">---</h2>
        </div>
        <div class="absolute top-[62%] left-0 w-full text-center z-20">
            <p id="status-msg" class="text-yellow-400 font-black uppercase text-sm drop-shadow-md bg-black/40 px-6 py-2 inline-block rounded-full border border-yellow-500/30"></p>
        </div>
        <div class="mt-auto flex justify-center gap-1 pb-10" id="player-hand" style="min-height: 120px;"></div>
    </div>

    <div id="bet-modal" class="hidden fixed inset-0 z-[150] flex flex-col items-center pt-20 bg-black/60">
        <div id="bet-container" class="glass p-5 rounded-3xl text-center border-b-4 border-yellow-500 w-[85%] max-w-xs pointer-events-auto">
            <p id="bet-player-name" class="text-yellow-500 text-xs font-bold uppercase mb-1"></p>
            <h2 class="text-xl font-black mb-4 text-white">¬øCU√ÅNTAS PIDES?</h2>
            <div id="bet-options" class="flex flex-wrap justify-center gap-2"></div>
            <p id="online-forbidden-msg" class="text-red-500 text-[10px] font-bold mt-4 uppercase hidden">‚ö†Ô∏è PROHIBIDO <span id="online-forbidden-val"></span></p>
        </div>
    </div>

    <div id="ranking-modal" class="modal-rank">
        <div class="glass w-full max-w-sm p-6 rounded-3xl text-center">
            <h2 class="text-2xl font-black mb-6 text-yellow-500 italic uppercase">Clasificaci√≥n</h2>
            <table class="w-full mb-6 text-white text-sm">
                <tbody id="ranking-table"></tbody>
            </table>
            <button onclick="closeRanking()" class="w-full bg-white text-black py-4 rounded-2xl font-black uppercase">Siguiente Ronda</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBUXvMwtXc2S_lNghaWOPwvKF5Z7EDB2lQ",
            authDomain: "pochaonline-ebbc1.firebaseapp.com",
            databaseURL: "https://pochaonline-ebbc1-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "pochaonline-ebbc1"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let players = []; let roundsSeq = []; let currentIdx = 0;
        let isBettingPhase = true; let myName = ""; let roomRef = null; let gameState = null;
        const emojis = {'OROS': 'üü°', 'COPAS': 'üç∑', 'ESPADAS': '‚öîÔ∏è', 'BASTOS': 'ü™µ'};

        function showScreen(id) {
            document.querySelectorAll('body > div').forEach(div => div.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            if(id === 'online-lobby') initOnline();
        }

        function generatePochaSeq(nP, total) {
            let s = []; const max = Math.floor(total / nP);
            for(let i=0; i<nP; i++) s.push(1);
            for(let i=2; i<max; i++) s.push(i);
            for(let i=0; i<nP; i++) s.push(max);
            for(let i=max-1; i>=2; i--) s.push(i);
            for(let i=0; i<nP; i++) s.push(1);
            return s;
        }

        /* --- BOLO (LOCAL) --- */
        function addPlayerBolo() {
            const val = document.getElementById('p-name-bolo').value.trim().toUpperCase();
            if(val) { players.push({ name: val, score: 0, bet: 0, lastDiff: 0 }); document.getElementById('p-name-bolo').value = ''; renderPlayersBolo(); }
        }
        function renderPlayersBolo() {
            document.getElementById('p-list-bolo').innerHTML = players.map(p => `<li>üë§ ${p.name}</li>`).join('');
            if(players.length >= 2) document.getElementById('btn-start-bolo').classList.remove('hidden');
        }
        function startGameBolo() {
            roundsSeq = generatePochaSeq(players.length, 40);
            showScreen('bolo-game'); initPhaseBolo();
        }
        function initPhaseBolo() {
            const c = roundsSeq[currentIdx];
            document.getElementById('b-round-label').innerText = `RONDA ${currentIdx+1} / ${roundsSeq.length}`;
            document.getElementById('b-cards-label').innerText = `${c} ${c===1?'CARTA':'CARTAS'}`;
            document.getElementById('b-players-actions').innerHTML = players.map((p, i) => `
                <div class="flex justify-between items-center p-3 border-b border-white/10">
                    <span class="font-bold">${p.name} ${!isBettingPhase?`<span class="text-[10px] text-blue-400 block">Pidi√≥ ${p.bet}</span>`:''}</span>
                    <input type="number" id="b-input-${i}" class="w-16 p-2 input-dark text-center font-bold" oninput="checkBoloRule()">
                </div>`).join('');
            checkBoloRule();
        }
        function checkBoloRule() {
            if(!isBettingPhase) return;
            const cards = roundsSeq[currentIdx];
            let sum = 0;
            for(let i=0; i<players.length-1; i++) sum += parseInt(document.getElementById(`b-input-${i}`).value) || 0;
            const forbidden = cards - sum;
            const last = document.getElementById(`b-input-${players.length-1}`);
            const isErr = (forbidden >= 0 && forbidden <= cards && parseInt(last.value) === forbidden);
            document.getElementById('b-rule-warning').classList.toggle('hidden', !(forbidden >= 0 && forbidden <= cards));
            if(forbidden >= 0 && forbidden <= cards) document.getElementById('b-forbidden-val').innerText = forbidden;
            document.getElementById('b-main-btn').disabled = isErr;
            document.getElementById('b-main-btn').style.opacity = isErr ? "0.3" : "1";
        }
        function processPhaseBolo() {
            if(isBettingPhase) {
                players.forEach((p, i) => p.bet = parseInt(document.getElementById(`b-input-${i}`).value) || 0);
                isBettingPhase = false; initPhaseBolo();
            } else {
                players.forEach((p, i) => {
                    const m = parseInt(document.getElementById(`b-input-${i}`).value) || 0;
                    p.lastDiff = (m === p.bet) ? (10 + p.bet * 5) : -5;
                    p.score += p.lastDiff;
                });
                showRankingBolo();
            }
        }
        function showRankingBolo() {
            const sorted = [...players].sort((a,b) => b.score - a.score);
            document.getElementById('ranking-table').innerHTML = sorted.map((p, i) => `<tr><td class="py-2 text-left">${i+1}. ${p.name}</td><td class="py-2 text-right">${p.score} (${p.lastDiff>0?'+':''}${p.lastDiff})</td></tr>`).join('');
            document.getElementById('ranking-modal').style.display = 'flex';
        }
        function closeRanking() {
            document.getElementById('ranking-modal').style.display = 'none';
            if(currentIdx < roundsSeq.length-1) { currentIdx++; isBettingPhase = true; initPhaseBolo(); }
            else location.reload();
        }

        /* --- ONLINE --- */
        function initOnline() {
            myName = prompt("NOMBRE:").toUpperCase();
            roomCode = prompt("SALA:").toUpperCase();
            if(!myName || !roomCode) return location.reload();
            roomRef = db.ref('rooms/' + roomCode);
            roomRef.on('value', snap => { gameState = snap.val(); if(gameState) renderOnline(); });
            roomRef.once('value', snap => {
                let d = snap.val() || { players: [], roundIdx: 0, turn: 0, phase: 'LOBBY', cardsPlayed: 0 };
                if(!d.players.find(p => p.name === myName)) d.players.push({ name: myName, score: 0, bet: -1, made: 0, hand: [] });
                roomRef.set(d);
            });
            showScreen('online-game-screen');
        }

        function renderOnline() {
            const me = gameState.players.find(p => p.name === myName);
            const activeP = gameState.players[gameState.turn];
            const myTurn = activeP.name === myName;
            const pochaSeq = generatePochaSeq(gameState.players.length, 40);
            const currentCards = pochaSeq[gameState.roundIdx];

            if(gameState.phase === 'LOBBY') {
                document.getElementById('status-msg').innerHTML = gameState.players[0].name === myName ? 
                    `<button onclick="startOnlineRound()" class="bg-green-600 px-6 py-2 rounded-xl border-2 pointer-events-auto font-bold">REPARTIR ${currentCards}</button>` : `ESPERANDO AL L√çDER...`;
                return;
            }

            document.getElementById('online-scores').innerHTML = gameState.players.map(p => 
                `<div class="${p.name===activeP.name?'text-yellow-400 font-bold':''}">${p.name}: ${p.score} [${p.made}/${p.bet<0?'?':p.bet}]</div>`).join('');
            
            const tDiv = document.getElementById('trump-slot'); tDiv.innerHTML = '';
            if(gameState.trump) tDiv.appendChild(createCardUI(gameState.trump));

            const b = document.getElementById('board'); b.innerHTML = '';
            gameState.players.forEach((p, i) => {
                if(p.played) {
                    const c = createCardUI(p.played); c.classList.add('played-card');
                    const ang = i * (360 / gameState.players.length);
                    c.style.transform = `rotate(${ang}deg) translateY(-68px) rotate(-${ang}deg)`;
                    b.appendChild(c);
                }
            });

            const h = document.getElementById('player-hand'); h.innerHTML = '';
            if(me.hand) me.hand.forEach((c, i) => {
                const ui = createCardUI(c);
                if(myTurn && gameState.phase === 'PLAYING') { ui.onclick = () => playOnlineCard(i); ui.classList.add('card-active'); }
                h.appendChild(ui);
            });

            const bMod = document.getElementById('bet-modal');
            if(gameState.phase === 'BETTING') {
                bMod.classList.remove('hidden');
                document.getElementById('bet-player-name').innerText = activeP.name;
                const opts = document.getElementById('bet-options'); opts.innerHTML = '';
                if(myTurn) {
                    const bCount = gameState.players.filter(p => p.bet !== -1).length;
                    const isL = bCount === gameState.players.length - 1;
                    let forbidden = isL ? (currentCards - gameState.players.reduce((a,p)=>a+(p.bet===-1?0:p.bet),0)) : -1;
                    document.getElementById('online-forbidden-msg').classList.toggle('hidden', !(isL && forbidden >= 0 && forbidden <= currentCards));
                    if(isL) document.getElementById('online-forbidden-val').innerText = forbidden;
                    for(let i=0; i<=currentCards; i++) {
                        const btn = document.createElement('button');
                        btn.className = "w-10 h-10 bg-yellow-500 text-black font-black rounded-lg "+(i===forbidden?'opacity-20 pointer-events-none':'');
                        btn.innerText = i; btn.onclick = () => makeOnlineBet(i);
                        opts.appendChild(btn);
                    }
                } else opts.innerHTML = '<p class="text-white opacity-40">Esperando apuesta...</p>';
            } else bMod.classList.add('hidden');
            document.getElementById('status-msg').innerText = myTurn ? "¬°TU TURNO!" : "TURNO DE " + activeP.name;
        }

        function startOnlineRound() {
            const seq = generatePochaSeq(gameState.players.length, 40);
            const cards = seq[gameState.roundIdx];
            const d = []; ['OROS','COPAS','ESPADAS','BASTOS'].forEach(s => [1,2,3,4,5,6,7,10,11,12].forEach(v => d.push({s,v})));
            d.sort(() => Math.random() - 0.5);
            gameState.players.forEach(p => { p.hand = d.splice(0, cards); p.bet = -1; p.made = 0; p.played = null; });
            gameState.trump = d.pop(); gameState.phase = 'BETTING'; gameState.turn = 0; gameState.firstSuit = null; gameState.cardsPlayed = 0;
            roomRef.set(gameState);
        }

        function makeOnlineBet(n) {
            gameState.players[gameState.turn].bet = n;
            gameState.turn = (gameState.turn + 1) % gameState.players.length;
            if(gameState.players.every(p => p.bet !== -1)) gameState.phase = 'PLAYING';
            roomRef.set(gameState);
        }

        function playOnlineCard(i) {
            const pIdx = gameState.turn;
            gameState.players[pIdx].played = gameState.players[pIdx].hand.splice(i, 1)[0];
            if(!gameState.firstSuit) gameState.firstSuit = gameState.players[pIdx].played.s;
            gameState.cardsPlayed++;
            
            if(gameState.cardsPlayed === gameState.players.length) {
                roomRef.set(gameState); // Sincroniza antes de resolver
                setTimeout(resolveOnlineBaza, 1500);
            } else {
                gameState.turn = (gameState.turn + 1) % gameState.players.length;
                roomRef.set(gameState);
            }
        }

        function resolveOnlineBaza() {
            let winIdx = 0; let bestP = -1;
            gameState.players.forEach((p, i) => {
                let v = p.played.v; if(v === 1) v = 20; if(v === 3) v = 15;
                let power = (p.played.s === gameState.trump.s) ? v + 100 : (p.played.s === gameState.firstSuit ? v : 0);
                if(power > bestP) { bestP = power; winIdx = i; }
            });
            
            document.getElementById('winner-name-msg').innerText = gameState.players[winIdx].name;
            document.getElementById('winner-notif').classList.add('show');

            setTimeout(() => {
                document.getElementById('winner-notif').classList.remove('show');
                gameState.players[winIdx].made++;
                gameState.players.forEach(p => p.played = null);
                gameState.turn = winIdx; gameState.firstSuit = null; gameState.cardsPlayed = 0;
                
                // Comprobar fin de ronda (si nadie tiene cartas)
                if(gameState.players.every(p => !p.hand || p.hand.length === 0)) {
                    gameState.players.forEach(p => {
                        if(p.bet === p.made) p.score += (10 + p.bet * 5);
                        else p.score -= 5;
                    });
                    gameState.roundIdx++;
                    gameState.phase = 'LOBBY';
                }
                roomRef.set(gameState);
            }, 2000);
        }

        function createCardUI(c) {
            const d = document.createElement('div'); d.className = 'card';
            const val = c.v === 1 ? 'A' : (c.v === 10 ? 'S' : (c.v === 11 ? 'C' : (c.v === 12 ? 'R' : c.v)));
            d.innerHTML = `<div class="text-[10px] self-start">${val}</div><div class="text-3xl">${emojis[c.s]}</div><div class="text-[10px] self-end rotate-180">${val}</div>`;
            return d;
        }
    </script>
</body>
</html>