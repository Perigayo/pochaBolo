<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>POCHA MASTER ULTIMATE</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --p-green: #064e3b; --p-gold: #fbbf24; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Segoe UI', Roboto, sans-serif; }
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: var(--p-green); color: white; }
        
        /* Layout Principal */
        .app-container { height: 100%; display: flex; flex-direction: column; padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom); }
        .glass { background: rgba(0,0,0,0.6); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; }
        
        /* Cartas */
        .card { width: 55px; height: 85px; background: white; border-radius: 8px; color: black; position: relative; display: flex; flex-direction: column; justify-content: space-between; padding: 5px; font-weight: 900; box-shadow: 0 4px 10px rgba(0,0,0,0.3); border: 1px solid #ddd; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .card-active:active { transform: translateY(-20px) scale(1.1); border: 3px solid var(--p-gold); }
        .card.disabled { opacity: 0.4; filter: grayscale(1); transform: scale(0.9); pointer-events: none; }
        
        /* Mesa */
        .table { flex: 1; position: relative; display: flex; items-center; justify-center; }
        .played-card-slot { position: absolute; width: 55px; height: 85px; transition: all 0.5s ease-in-out; }
        
        /* Animaciones */
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .pop-in { animation: popIn 0.4s forwards; }
        
        .btn-main { background: var(--p-gold); color: black; font-weight: 900; text-transform: uppercase; border-radius: 16px; padding: 16px; box-shadow: 0 4px 0 #b45309; transition: all 0.1s; }
        .btn-main:active { transform: translateY(2px); box-shadow: 0 2px 0 #b45309; }
    </style>
</head>
<body>

<div id="app" class="app-container">
    <div id="screen-start" class="h-full flex flex-col items-center justify-center gap-6">
        <div class="text-center">
            <div class="w-32 h-32 bg-zinc-900 rounded-full mx-auto mb-4 border-4 border-yellow-500 flex items-center justify-center overflow-hidden">
                <img src="https://files.oaiusercontent.com/file-S46YI7T6T3N9S6X7W9Z1X2?se=2024-05-22T12%3A00%3A00Z&sp=r&sv=2021-08-06&sr=b&rscc=max-age%3D604800%2C%20immutable&rscd=attachment%3B%20filename%3Dapple_worm_icon.png" class="w-full h-full object-cover">
            </div>
            <h1 class="text-5xl font-black italic text-yellow-500 tracking-tighter">POCHA PRO</h1>
        </div>
        <div class="w-full max-w-xs flex flex-col gap-3">
            <button onclick="nav('online-setup')" class="btn-main text-lg">üåê Juego Online</button>
            <button onclick="nav('bolo-setup')" class="bg-zinc-800 p-4 rounded-2xl font-bold border border-white/10">üìù Marcador Bolo</button>
        </div>
    </div>

    <div id="screen-online-setup" class="hidden h-full flex flex-col justify-center gap-4">
        <div class="glass p-6 space-y-4">
            <h2 class="text-center font-black text-yellow-500">NUEVA PARTIDA</h2>
            <input type="text" id="p-name" placeholder="TU NOMBRE" class="w-full p-4 rounded-xl bg-black/40 border border-white/20 uppercase font-bold">
            <input type="text" id="p-room" placeholder="C√ìDIGO SALA" class="w-full p-4 rounded-xl bg-black/40 border border-white/20 uppercase font-bold">
            <button onclick="startOnline()" class="btn-main w-full">Entrar a la Mesa</button>
            <button onclick="nav('start')" class="w-full text-xs opacity-50 font-bold">VOLVER</button>
        </div>
    </div>

    <div id="screen-game" class="hidden h-full flex flex-col">
        <div class="flex justify-between items-center py-2">
            <div id="game-info" class="text-[10px] font-bold bg-black/30 p-2 rounded-lg border border-white/10">SALA: -</div>
            <div id="trump-slot"></div>
        </div>

        <div class="table">
            <div id="score-board" class="absolute top-0 left-0 glass p-2 text-[10px] z-50 min-w-[100px]"></div>
            <div id="board-center" class="relative w-full h-full"></div>
            <div id="msg-overlay" class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <div id="status-label" class="bg-yellow-500 text-black px-4 py-1 rounded-full font-black text-xs uppercase shadow-xl transform -rotate-2">Esperando...</div>
            </div>
        </div>

        <div class="pb-6">
            <div id="my-hand" class="flex justify-center gap-1 overflow-x-auto py-4 px-2 min-h-[120px]"></div>
        </div>
    </div>

    <div id="modal-bet" class="hidden fixed inset-0 z-[100] bg-black/90 backdrop-blur-sm flex items-center justify-center p-6">
        <div class="glass p-6 w-full max-w-xs text-center border-t-4 border-yellow-500">
            <p class="text-[10px] text-yellow-500 font-bold mb-2 uppercase">Mira tus cartas y pide:</p>
            <div id="bet-cards" class="flex justify-center gap-1 mb-6 scale-90"></div>
            <div id="bet-options" class="grid grid-cols-4 gap-2"></div>
            <p id="bet-forbidden" class="text-red-500 text-[10px] mt-4 font-bold hidden uppercase italic">‚ö†Ô∏è Bloqueado por regla del "No Vale"</p>
        </div>
    </div>
</div>

<script>
    // Configuraci√≥n Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBUXvMwtXc2S_lNghaWOPwvKF5Z7EDB2lQ",
        databaseURL: "https://pochaonline-ebbc1-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "pochaonline-ebbc1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Variables de Estado
    let user = { name: localStorage.getItem('pocha_name') || "", room: "" };
    if(user.name) document.getElementById('p-name').value = user.name;

    let roomRef = null;
    let state = null;
    const suits = { 'OROS': 'üü°', 'COPAS': 'üç∑', 'ESPADAS': '‚öîÔ∏è', 'BASTOS': 'ü™µ' };

    function nav(id) {
        document.querySelectorAll('.app-container > div').forEach(d => d.classList.add('hidden'));
        document.getElementById('screen-' + id).classList.remove('hidden');
    }

    async function startOnline() {
        const n = document.getElementById('p-name').value.trim().toUpperCase();
        const r = document.getElementById('p-room').value.trim().toUpperCase();
        if(!n || !r) return alert("Rellena todo");
        
        user.name = n; user.room = r;
        localStorage.setItem('pocha_name', n);
        
        roomRef = db.ref('rooms/' + r);
        
        // Unirse o Crear
        const snap = await roomRef.get();
        let data = snap.val() || {
            players: [],
            phase: 'LOBBY',
            round: 0,
            turn: 0,
            trump: null,
            firstSuit: null,
            bazaCount: 0
        };

        if(!data.players.find(p => p.name === n)) {
            if(data.phase !== 'LOBBY') return alert("Partida en curso");
            data.players.push({ name: n, score: 0, hand: [], bet: -1, made: 0, played: null });
            await roomRef.set(data);
        }

        roomRef.on('value', s => {
            state = s.val();
            if(state) render();
        });

        nav('game');
    }

    function render() {
        const me = state.players.find(p => p.name === user.name);
        const isMyTurn = state.players[state.turn]?.name === user.name;
        const totalCards = getSequence(state.players.length)[state.round];

        // 1. Info Superior
        document.getElementById('game-info').innerText = `SALA: ${user.room} | RONDA: ${state.round + 1} (${totalCards} cartas)`;
        document.getElementById('trump-slot').innerHTML = state.trump ? createCardUI(state.trump, 'small') : '';

        // 2. Marcador
        document.getElementById('score-board').innerHTML = state.players.map(p => `
            <div class="${state.players[state.turn]?.name === p.name ? 'text-yellow-400 font-bold' : 'opacity-60'}">
                ${p.name}: ${p.score} <span class="float-right">[${p.made}/${p.bet < 0 ? '?' : p.bet}]</span>
            </div>
        `).join('');

        // 3. Mesa
        const board = document.getElementById('board-center');
        board.innerHTML = "";
        state.players.forEach((p, i) => {
            if(p.played) {
                const angle = i * (360 / state.players.length);
                const el = document.createElement('div');
                el.className = "played-card-slot pop-in";
                el.style.left = "50%"; el.style.top = "50%";
                el.style.transform = `translate(-50%, -50%) rotate(${angle}deg) translateY(-70px) rotate(-${angle}deg)`;
                el.innerHTML = createCardUI(p.played);
                board.appendChild(el);
            }
        });

        // 4. L√≥gica de Fases
        const status = document.getElementById('status-label');
        const modalBet = document.getElementById('modal-bet');

        if(state.phase === 'LOBBY') {
            status.innerText = "Esperando inicio";
            if(state.players[0].name === user.name) {
                status.innerHTML = `<button onclick="deal()" class="bg-white text-black px-4 py-1 rounded-full font-black">REPARTIR ${totalCards}</button>`;
            }
            modalBet.classList.add('hidden');
        } 
        else if(state.phase === 'BETTING') {
            status.innerText = "Pidiendo...";
            if(isMyTurn) {
                modalBet.classList.remove('hidden');
                renderBetOptions(me, totalCards);
            } else {
                modalBet.classList.add('hidden');
            }
        } 
        else if(state.phase === 'PLAYING') {
            modalBet.classList.add('hidden');
            status.innerText = isMyTurn ? "¬°Te toca echar!" : `Turno de ${state.players[state.turn].name}`;
        }

        // 5. Mi Mano
        const handUI = document.getElementById('my-hand');
        handUI.innerHTML = "";
        if(me && me.hand) {
            const hasSuit = me.hand.some(c => c.s === state.firstSuit);
            me.hand.forEach((card, idx) => {
                const cardDiv = document.createElement('div');
                const canPlay = state.phase === 'PLAYING' && isMyTurn && (!state.firstSuit || card.s === state.firstSuit || !hasSuit);
                cardDiv.innerHTML = createCardUI(card, 'normal', !canPlay && state.phase === 'PLAYING');
                if(canPlay) cardDiv.onclick = () => playCard(idx);
                handUI.appendChild(cardDiv);
            });
        }
    }

    function renderBetOptions(me, totalCards) {
        const container = document.getElementById('bet-options');
        const cardsPreview = document.getElementById('bet-cards');
        container.innerHTML = "";
        cardsPreview.innerHTML = me.hand.map(c => createCardUI(c, 'small')).join('');

        const betsDone = state.players.filter(p => p.bet !== -1).length;
        const currentSum = state.players.reduce((a, b) => a + (b.bet === -1 ? 0 : b.bet), 0);
        const forbidden = (betsDone === state.players.length - 1) ? (totalCards - currentSum) : -1;

        document.getElementById('bet-forbidden').classList.toggle('hidden', forbidden < 0 || forbidden > totalCards);

        for(let i=0; i <= totalCards; i++) {
            const btn = document.createElement('button');
            btn.className = `p-3 rounded-xl font-black ${i === forbidden ? 'bg-zinc-800 text-zinc-600' : 'bg-yellow-500 text-black'}`;
            btn.innerText = i;
            btn.disabled = (i === forbidden);
            btn.onclick = () => submitBet(i);
            container.appendChild(btn);
        }
    }

    async function submitBet(n) {
        let players = [...state.players];
        players[state.turn].bet = n;
        let nextTurn = (state.turn + 1) % players.length;
        let nextPhase = players.every(p => p.bet !== -1) ? 'PLAYING' : 'BETTING';
        await roomRef.update({ players, turn: nextTurn, phase: nextPhase, firstSuit: null });
    }

    async function playCard(idx) {
        let players = [...state.players];
        let card = players[state.turn].hand.splice(idx, 1)[0];
        players[state.turn].played = card;
        
        let firstSuit = state.firstSuit || card.s;
        let bazaCount = state.bazaCount + 1;
        let nextTurn = (state.turn + 1) % players.length;

        if(bazaCount === players.length) {
            // Fin de la baza
            await roomRef.update({ players, bazaCount, firstSuit });
            setTimeout(resolveBaza, 2500);
        } else {
            await roomRef.update({ players, turn: nextTurn, bazaCount, firstSuit });
        }
    }

    async function resolveBaza() {
        let players = [...state.players];
        let winnerIdx = 0;
        let maxPower = -1;

        players.forEach((p, i) => {
            let v = p.played.v;
            if(v === 1) v = 20; if(v === 3) v = 15;
            let power = (p.played.s === state.trump.s) ? v + 100 : (p.played.s === state.firstSuit ? v : 0);
            if(power > maxPower) { maxPower = power; winnerIdx = i; }
        });

        players[winnerIdx].made++;
        players.forEach(p => p.played = null);

        let isRoundOver = players[0].hand.length === 0;
        let update = { players, turn: winnerIdx, firstSuit: null, bazaCount: 0 };

        if(isRoundOver) {
            players.forEach(p => {
                if(p.bet === p.made) p.score += (10 + p.made * 5);
                else p.score -= 5;
                p.bet = -1; p.made = 0;
            });
            update.round = state.round + 1;
            update.phase = 'LOBBY';
        }

        await roomRef.update(update);
    }

    async function deal() {
        const n = getSequence(state.players.length)[state.round];
        const deck = [];
        ['OROS','COPAS','ESPADAS','BASTOS'].forEach(s => [1,2,3,4,5,6,7,10,11,12].forEach(v => deck.push({s,v})));
        deck.sort(() => Math.random() - 0.5);

        let players = [...state.players];
        players.forEach(p => {
            p.hand = deck.splice(0, n);
            p.bet = -1; p.made = 0; p.played = null;
        });

        await roomRef.update({
            players,
            trump: deck.pop(),
            phase: 'BETTING',
            turn: state.round % players.length,
            firstSuit: null,
            bazaCount: 0
        });
    }

    function createCardUI(c, mode = 'normal', disabled = false) {
        const v = c.v === 1 ? 'A' : (c.v === 10 ? 'S' : (c.v === 11 ? 'C' : (c.v === 12 ? 'R' : c.v)));
        const size = mode === 'small' ? 'scale-75 -m-2' : '';
        return `<div class="card ${size} ${disabled ? 'disabled' : 'card-active'}">
            <div class="text-[10px] leading-none">${v}</div>
            <div class="text-2xl text-center">${suits[c.s]}</div>
            <div class="text-[10px] leading-none self-end rotate-180">${v}</div>
        </div>`;
    }

    function getSequence(nP) {
        let s = []; const max = Math.floor(40/nP);
        for(let i=0;i<nP;i++) s.push(1); for(let i=2;i<max;i++) s.push(i);
        for(let i=0;i<nP;i++) s.push(max); for(let i=max-1;i>=2;i--) s.push(i);
        for(let i=0;i<nP;i++) s.push(1); return s;
    }

</script>
</body>
</html>