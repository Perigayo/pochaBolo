<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>POCHA BOLO</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --bg: #064e3b; --gold: #fbbf24; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: sans-serif; }
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: var(--bg); color: white; }
        .safe-area { padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom); height: 100%; display: flex; flex-direction: column; }
        .glass { background: rgba(0,0,0,0.85); backdrop-filter: blur(12px); border-radius: 24px; border: 1px solid rgba(255,255,255,0.1); }
        .card { width: 52px; height: 78px; background: white; border-radius: 8px; color: black; display: flex; flex-direction: column; justify-content: space-between; padding: 5px; font-weight: 900; box-shadow: 0 4px 10px rgba(0,0,0,0.4); }
        .card-active:active { transform: translateY(-15px) scale(1.1); border: 2px solid var(--gold); }
        .card.disabled { opacity: 0.3; filter: grayscale(1); pointer-events: none; }
        .table-zone { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; }
        .played-card { position: absolute; width: 52px; height: 78px; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .btn-gold { background: var(--gold); color: black; font-weight: 900; border-radius: 18px; padding: 18px; transition: all 0.1s; text-transform: uppercase; }
        .btn-gold:disabled { background: #3f3f46; color: #71717a; }
    </style>
</head>
<body>

<div class="safe-area">
    <div id="screen-menu" class="h-full flex flex-col items-center justify-center space-y-10">
        <div class="text-center">
            <h1 class="text-6xl font-black italic text-yellow-500 tracking-tighter drop-shadow-2xl">POCHA</h1>
            <p class="text-yellow-500/50 font-bold tracking-[0.3em] text-[10px]">SUPREME EDITION 2026</p>
        </div>
        <div class="w-full max-w-xs space-y-4">
            <button onclick="show('online-setup')" class="btn-gold w-full text-lg shadow-lg">üåê Juego Online</button>
            <button onclick="show('bolo-setup')" class="w-full py-4 glass font-bold text-zinc-400">üìù Marcador Bolo</button>
        </div>
    </div>

    <div id="screen-online-setup" class="hidden h-full flex flex-col justify-center p-4">
        <div class="glass p-8 space-y-6">
            <h2 class="text-center font-black text-yellow-500 uppercase">Nueva Partida</h2>
            <input type="text" id="p-name" placeholder="TU NOMBRE" class="w-full p-4 rounded-2xl bg-black/40 border border-white/10 uppercase font-bold text-center outline-none">
            <input type="text" id="p-room" placeholder="C√ìDIGO SALA" class="w-full p-4 rounded-2xl bg-black/40 border border-white/10 uppercase font-bold text-center text-yellow-500 outline-none">
            <button onclick="initOnline()" class="btn-gold w-full">Entrar</button>
            <button onclick="show('menu')" class="w-full text-xs opacity-40 font-bold py-2">Volver</button>
        </div>
    </div>

    <div id="screen-game" class="hidden h-full flex flex-col">
        <div class="flex justify-between items-center py-3 px-2 z-50">
            <div id="ui-room" class="bg-black/60 px-4 py-1.5 rounded-full text-[10px] font-black border border-white/10 uppercase">SALA: -</div>
            <div id="ui-trump" class="scale-90 origin-right"></div>
        </div>
        <div class="table-zone">
            <div id="ui-scores" class="absolute top-2 left-2 glass p-4 text-[10px] z-50 min-w-[130px] border-l-4 border-yellow-500"></div>
            <div id="table-cards" class="relative w-full h-full"></div>
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <div id="ui-status-container" class="pointer-events-auto"></div>
            </div>
        </div>
        <div class="pb-10"><div id="ui-hand" class="flex justify-center gap-2 overflow-x-auto py-6 px-4 min-h-[140px]"></div></div>
    </div>

    <div id="screen-bolo-setup" class="hidden h-full flex flex-col p-6 justify-center">
        <div class="glass p-6 space-y-4">
            <h2 class="text-xl font-black text-center text-yellow-500 uppercase italic">Jugadores Bolo</h2>
            <div class="flex gap-2">
                <input type="text" id="bolo-new-p" class="flex-1 p-4 bg-black/40 rounded-xl border border-white/10 font-bold uppercase" placeholder="NOMBRE">
                <button onclick="addBoloP()" class="bg-yellow-600 px-6 rounded-xl font-black text-2xl">+</button>
            </div>
            <div id="bolo-list" class="space-y-2 max-h-48 overflow-y-auto"></div>
            <button id="btn-bolo-start" onclick="startBolo()" class="hidden btn-gold w-full shadow-lg">Empezar Bolo</button>
            <button onclick="show('menu')" class="w-full text-xs opacity-40 font-bold py-2 uppercase">Cerrar</button>
        </div>
    </div>

    <div id="screen-bolo-board" class="hidden h-full flex flex-col py-6 px-4">
        <div class="glass p-4 text-center mb-4 border-b-4 border-yellow-500">
            <p id="bolo-info" class="text-[10px] text-yellow-500 font-bold uppercase tracking-widest"></p>
            <h2 id="bolo-cards" class="text-6xl font-black italic">--</h2>
        </div>
        <div class="flex-1 glass p-4 overflow-y-auto space-y-4" id="bolo-inputs"></div>
        <div id="bolo-rule" class="hidden bg-red-500/20 text-red-500 p-3 rounded-xl text-[10px] font-bold text-center mb-2 italic tracking-tighter">‚ö†Ô∏è LA SUMA NO PUEDE SER <span id="bolo-forbid" class="text-lg"></span></div>
        <button id="btn-bolo-next" onclick="nextBolo()" class="btn-gold w-full text-xl py-5">Confirmar</button>
    </div>

    <div id="modal-bet" class="hidden fixed inset-0 z-[200] bg-black/95 flex items-center justify-center p-6">
        <div class="glass p-8 w-full max-w-md text-center border-t-4 border-yellow-500">
            <div class="flex flex-col items-center gap-4 mb-6">
                <div class="flex items-center gap-3 bg-white/5 p-3 rounded-2xl border border-white/5">
                    <span class="text-[10px] font-black text-yellow-500 uppercase tracking-widest">PINTA:</span>
                    <div id="bet-trump"></div>
                </div>
                <div id="bet-hand" class="flex justify-center gap-1 scale-90 opacity-80"></div>
            </div>
            <p class="text-xs font-black mb-6 uppercase">¬øCu√°ntas vas a ganar?</p>
            <div id="bet-opts" class="grid grid-cols-4 gap-3"></div>
        </div>
    </div>

    <div id="modal-rank" class="hidden fixed inset-0 z-[300] bg-black/98 flex items-center justify-center p-4">
        <div class="glass w-full max-w-xs p-10 text-center">
            <h2 class="text-3xl font-black text-yellow-500 italic mb-8 uppercase">Ranking</h2>
            <div id="rank-content" class="space-y-4 mb-10 text-lg"></div>
            <button onclick="closeRank()" class="btn-gold w-full">Continuar</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBUXvMwtXc2S_lNghaWOPwvKF5Z7EDB2lQ",
        databaseURL: "https://pochaonline-ebbc1-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "pochaonline-ebbc1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let state = null;
    let myName = "";
    let roomCode = "";
    let bolo = { players: [], round: 0, betting: true };
    const suits = { 'OROS': 'üü°', 'COPAS': 'üç∑', 'ESPADAS': '‚öîÔ∏è', 'BASTOS': 'ü™µ' };

    function show(id) {
        document.querySelectorAll('.safe-area > div').forEach(d => d.classList.add('hidden'));
        document.getElementById('screen-' + id).classList.remove('hidden');
    }

    // --- L√ìGICA ONLINE ---
    async function initOnline() {
        myName = document.getElementById('p-name').value.trim().toUpperCase();
        roomCode = document.getElementById('p-room').value.trim().toUpperCase();
        if(!myName || !roomCode) return;
        const ref = db.ref('rooms/' + roomCode);
        const snap = await ref.get();
        let data = snap.val() || { players: [], phase: 'LOBBY', round: 0, turn: 0 };
        if(!data.players.find(p => p.name === myName)) {
            data.players.push({ name: myName, score: 0, bet: -1, made: 0, hand: [], played: null });
            await ref.set(data);
        }
        ref.on('value', s => { state = s.val(); if(state) renderOnline(); });
        show('game');
    }

    function renderOnline() {
        const me = state.players.find(p => p.name === myName);
        const isTurn = state.players[state.turn]?.name === myName;
        const nCards = getSeq(state.players.length)[state.round];

        document.getElementById('ui-room').innerText = `SALA: ${roomCode} | R ${state.round + 1}`;
        document.getElementById('ui-trump').innerHTML = state.trump ? cardUI(state.trump, 'small') : '';
        document.getElementById('ui-scores').innerHTML = state.players.map(p => `<div class="mb-1 ${state.players[state.turn]?.name === p.name ? 'text-yellow-400 font-bold' : 'opacity-40'}">${p.name}: ${p.score} <span class="float-right">[${p.made}/${p.bet < 0 ? '?' : p.bet}]</span></div>`).join('');

        const statusCont = document.getElementById('ui-status-container');
        if(state.phase === 'LOBBY') {
            statusCont.innerHTML = state.players[0].name === myName ? `<button onclick="deal()" class="bg-white text-black px-10 py-4 rounded-full font-black text-xs uppercase">Repartir ${nCards}</button>` : `<div class="bg-zinc-800 px-8 py-3 rounded-full text-[10px] font-black uppercase">Esperando...</div>`;
        } else {
            statusCont.innerHTML = `<div class="bg-yellow-500 text-black px-6 py-2 rounded-full font-black text-[10px] uppercase shadow-2xl">${isTurn ? '¬°TU TURNO!' : 'TURNO DE ' + state.players[state.turn].name}</div>`;
        }

        const table = document.getElementById('table-cards'); table.innerHTML = "";
        state.players.forEach((p, i) => {
            if(p.played) {
                const angle = i * (360 / state.players.length);
                const div = document.createElement('div');
                div.className = "played-card";
                div.style.left = "50%"; div.style.top = "50%";
                div.style.transform = `translate(-50%, -50%) rotate(${angle}deg) translateY(-70px) rotate(-${angle}deg)`;
                div.innerHTML = cardUI(p.played);
                table.appendChild(div);
            }
        });

        const handUI = document.getElementById('ui-hand'); handUI.innerHTML = "";
        if(me && me.hand) {
            const hasSuit = me.hand.some(c => c.s === state.firstSuit);
            me.hand.forEach((c, idx) => {
                const canPlay = state.phase === 'PLAYING' && isTurn && (!state.firstSuit || c.s === state.firstSuit || !hasSuit);
                const el = document.createElement('div');
                el.innerHTML = cardUI(c, 'normal', !canPlay && state.phase === 'PLAYING');
                if(canPlay) el.onclick = () => playCard(idx);
                handUI.appendChild(el);
            });
        }

        const mBet = document.getElementById('modal-bet');
        if(state.phase === 'BETTING' && isTurn) {
            mBet.classList.remove('hidden');
            document.getElementById('bet-trump').innerHTML = cardUI(state.trump, 'small');
            document.getElementById('bet-hand').innerHTML = me.hand.map(c => cardUI(c, 'small')).join('');
            const opts = document.getElementById('bet-opts'); opts.innerHTML = "";
            const done = state.players.filter(p => p.bet !== -1).length;
            const sum = state.players.reduce((a, b) => a + (b.bet === -1 ? 0 : b.bet), 0);
            const forbid = (done === state.players.length - 1) ? (nCards - sum) : -1;
            for(let i=0; i<=nCards; i++) {
                const btn = document.createElement('button');
                btn.className = `p-4 rounded-2xl font-black ${i === forbid ? 'bg-zinc-800 text-zinc-600' : 'bg-yellow-500 text-black'}`;
                btn.innerText = i; btn.disabled = (i === forbid);
                btn.onclick = () => db.ref(`rooms/${roomCode}`).update({
                    [`players/${state.turn}/bet`]: i, turn: (state.turn + 1) % state.players.length,
                    phase: (done + 1 === state.players.length) ? 'PLAYING' : 'BETTING'
                });
                opts.appendChild(btn);
            }
        } else mBet.classList.add('hidden');
    }

    async function playCard(idx) {
        let players = [...state.players];
        let card = players[state.turn].hand.splice(idx, 1)[0];
        players[state.turn].played = card;
        let firstSuit = state.firstSuit || card.s;
        let turn = (state.turn + 1) % players.length;
        await db.ref(`rooms/${roomCode}`).update({ players, firstSuit, turn });
        if(players.every(p => p.played) && state.players[0].name === myName) setTimeout(resolveBaza, 2000);
    }

    async function resolveBaza() {
        let ps = [...state.players];
        let winner = 0; let best = -1;
        ps.forEach((p, i) => {
            let v = p.played.v === 1 ? 20 : (p.played.v === 3 ? 15 : p.played.v);
            let pwr = (p.played.s === state.trump.s) ? v + 100 : (p.played.s === state.firstSuit ? v : 0);
            if(pwr > best) { best = pwr; winner = i; }
        });
        ps[winner].made++; ps.forEach(p => p.played = null);
        let end = ps[0].hand ? ps[0].hand.length === 0 : true;
        let up = { players: ps, turn: winner, firstSuit: null };
        if(end) {
            ps.forEach(p => { p.score += (p.bet === p.made) ? (10 + p.made * 5) : -5; p.bet = -1; p.made = 0; p.hand = []; });
            up.round = state.round + 1; up.phase = 'LOBBY';
        }
        await db.ref(`rooms/${roomCode}`).update(up);
    }

    async function deal() {
        const n = getSeq(state.players.length)[state.round];
        const deck = [];
        ['OROS','COPAS','ESPADAS','BASTOS'].forEach(s => [1,2,3,4,5,6,7,10,11,12].forEach(v => deck.push({s,v})));
        deck.sort(() => Math.random() - 0.5);
        let ps = state.players.map(p => ({ ...p, hand: deck.splice(0, n), bet: -1, made: 0, played: null }));
        await db.ref(`rooms/${roomCode}`).update({ players: ps, trump: deck.pop(), phase: 'BETTING', turn: state.round % ps.length, firstSuit: null });
    }

    // --- L√ìGICA MARCADOR BOLO ---
    function addBoloP() {
        const v = document.getElementById('bolo-new-p').value.trim().toUpperCase();
        if(v) { bolo.players.push({ name: v, score: 0, bet: 0 }); document.getElementById('bolo-new-p').value = ""; renderBoloList(); }
    }
    function renderBoloList() {
        document.getElementById('bolo-list').innerHTML = bolo.players.map((p, i) => `<div class="flex justify-between p-4 glass text-sm font-bold"><span>üë§ ${p.name}</span><button onclick="bolo.players.splice(${i},1);renderBoloList()" class="text-red-500 font-black">QUITAR</button></div>`).join('');
        document.getElementById('btn-bolo-start').classList.toggle('hidden', bolo.players.length < 2);
    }
    function startBolo() { bolo.round = 0; bolo.betting = true; show('bolo-board'); updateBoloUI(); }
    function updateBoloUI() {
        const n = getSeq(bolo.players.length)[bolo.round];
        document.getElementById('bolo-info').innerText = `Ronda ${bolo.round + 1}`;
        document.getElementById('bolo-cards').innerText = n;
        const area = document.getElementById('bolo-inputs');
        area.innerHTML = `<h3 class="text-center font-bold text-yellow-500 uppercase text-[10px] mb-2">${bolo.betting ? '¬øCu√°ntas piden?' : '¬øCu√°ntas han hecho?'}</h3>` + 
            bolo.players.map((p, i) => `<div class="flex justify-between items-center p-4 glass"><span class="font-bold text-sm uppercase">${p.name} ${!bolo.betting ? `<small class="block text-blue-400">PIDI√ì ${p.bet}</small>` : ''}</span><input type="number" id="bi-${i}" class="w-20 p-3 bg-black rounded-xl text-center font-black text-2xl" oninput="checkBoloRule()"></div>`).join('');
        checkBoloRule();
    }
    function checkBoloRule() {
        if(!bolo.betting) return;
        const n = getSeq(bolo.players.length)[bolo.round];
        let sum = 0; for(let i=0; i<bolo.players.length-1; i++) sum += parseInt(document.getElementById('bi-'+i).value) || 0;
        const f = n - sum;
        const last = parseInt(document.getElementById('bi-'+(bolo.players.length-1)).value);
        const isF = (f >= 0 && f <= n);
        document.getElementById('bolo-rule').classList.toggle('hidden', !isF);
        if(isF) document.getElementById('bolo-forbid').innerText = f;
        document.getElementById('btn-bolo-next').disabled = (isF && last === f);
    }
    function nextBolo() {
        if(bolo.betting) {
            bolo.players.forEach((p, i) => p.bet = parseInt(document.getElementById('bi-'+i).value) || 0);
            bolo.betting = false; updateBoloUI();
        } else {
            bolo.players.forEach((p, i) => { const m = parseInt(document.getElementById('bi-'+i).value) || 0; p.score += (m === p.bet) ? (10 + m * 5) : -5; });
            document.getElementById('rank-content').innerHTML = [...bolo.players].sort((a,b)=>b.score-a.score).map(p => `<div class="flex justify-between font-black border-b border-white/10 pb-2"><span>${p.name}</span><span>${p.score}</span></div>`).join('');
            document.getElementById('modal-rank').classList.remove('hidden');
        }
    }
    function closeRank() { 
        if(document.getElementById('screen-game').classList.contains('hidden')) {
            document.getElementById('modal-rank').classList.add('hidden'); 
            bolo.round++; bolo.betting = true; updateBoloUI(); 
        } else {
            document.getElementById('modal-rank').classList.add('hidden');
        }
    }

    // AUXILIARES
    function cardUI(c, mode='normal', off=false) {
        const v = c.v === 1 ? 'A' : (c.v === 10 ? 'S' : (c.v === 11 ? 'C' : (c.v === 12 ? 'R' : c.v)));
        return `<div class="card ${mode==='small'?'scale-75':''} ${off?'disabled':'card-active'}"><div class="leading-none text-[10px]">${v}</div><div class="text-3xl text-center">${suits[c.s]}</div><div class="leading-none text-[10px] self-end rotate-180">${v}</div></div>`;
    }
    function getSeq(nP) {
        let s = []; const max = Math.floor(40/nP);
        for(let i=0;i<nP;i++) s.push(1); for(let i=2;i<max;i++) s.push(i);
        for(let i=0;i<nP;i++) s.push(max); for(let i=max-1;i>=2;i--) s.push(i);
        for(let i=0;i<nP;i++) s.push(1); return s;
    }
</script>
</body>
</html>