<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pocha BOLO</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1041/1041883.png">
    <link rel="manifest" href="manifest.json">

    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { background-color: #064e3b; color: white; font-family: sans-serif; overflow-x: hidden; }
        .glass { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .input-dark { background: #1a1a1a; border: 1px solid #444; color: white; border-radius: 12px; }
        .card { width: 60px; height: 88px; background: white; color: black; border-radius: 8px; display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding: 5px; font-weight: 900; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .table-center { background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 75%); border-radius: 50%; width: 220px; height: 220px; position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); border: 1px dashed rgba(255,255,255,0.2); }
        .played-card { position: absolute; transform-origin: center; left: 50%; top: 50%; margin-left: -30px; margin-top: -44px; z-index: 10; }
        .btn-forbidden { background: #450a0a !important; color: #ef4444 !important; opacity: 0.5; pointer-events: none; border: 1px solid #ef4444; }
        .active-mode { border-color: #eab308; background: #eab30833; color: #eab308; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 300; padding: 20px; }
    </style>
</head>
<body class="p-0 m-0">

    <div id="main-menu" class="flex flex-col items-center justify-center h-screen space-y-6 bg-[#064e3b] px-6">
        <h1 class="text-5xl font-black text-yellow-500 italic uppercase text-center leading-none">LA POCHA</h1>
        <div class="text-7xl">üçè</div>
        <div class="w-full max-w-xs space-y-4">
            <button onclick="showScreen('online-lobby')" class="w-full bg-blue-600 p-5 rounded-2xl font-black text-xl shadow-lg uppercase">üåê Jugar Online</button>
            <button onclick="showScreen('score-setup')" class="w-full bg-zinc-800 p-5 rounded-2xl font-black text-xl shadow-lg uppercase border border-white/10">üìù Marcador BOLO</button>
        </div>
    </div>

    <div id="score-setup" class="hidden min-h-screen p-6 max-w-md mx-auto">
        <button onclick="location.reload()" class="mb-4 text-gray-400 font-bold uppercase text-xs">‚Üê Volver</button>
        <h2 class="text-3xl font-black text-yellow-500 mb-6 italic uppercase">Configurar BOLO</h2>
        <div class="glass p-6 rounded-3xl space-y-6">
            <div class="flex gap-2">
                <button id="m40" onclick="setDeck(40)" class="flex-1 p-3 rounded-xl border-2 border-gray-600 active-mode font-bold">40 Cartas</button>
                <button id="m36" onclick="setDeck(36)" class="flex-1 p-3 rounded-xl border-2 border-gray-600 font-bold">36 Cartas</button>
            </div>
            <div class="flex gap-2">
                <input type="text" id="p-name-bolo" class="flex-1 p-4 input-dark font-bold" placeholder="Nombre...">
                <button onclick="addPlayerBolo()" class="bg-yellow-600 px-6 rounded-xl font-bold text-2xl">+</button>
            </div>
            <ul id="p-list-bolo" class="space-y-2 text-sm italic text-gray-300 border-l-2 border-yellow-600 pl-4"></ul>
            <button onclick="startGameBolo()" id="btn-start-bolo" class="hidden w-full bg-green-700 py-4 rounded-2xl font-black uppercase tracking-widest">Empezar</button>
        </div>
    </div>

    <div id="bolo-game" class="hidden min-h-screen p-4 max-w-md mx-auto space-y-4">
        <div class="glass p-4 rounded-2xl text-center border-b-4 border-yellow-600">
            <p id="b-round-label" class="text-xs text-yellow-500 uppercase font-bold"></p>
            <h2 id="b-cards-label" class="text-5xl font-black"></h2>
        </div>
        <div class="glass p-4 rounded-2xl">
            <h3 id="b-phase-title" class="text-center font-bold mb-4 uppercase tracking-tighter"></h3>
            <div id="b-players-actions" class="space-y-3"></div>
            <p id="b-rule-warning" class="mt-4 text-xs text-red-500 font-bold text-center hidden">‚ö†Ô∏è Prohibido pedir <span id="b-forbidden-val"></span></p>
        </div>
        <button id="b-main-btn" onclick="processPhaseBolo()" class="w-full bg-yellow-600 py-5 rounded-2xl font-black text-xl uppercase">Confirmar</button>
    </div>

    <div id="ranking-modal" class="modal flex-col items-center justify-center">
        <div class="glass w-full max-w-sm p-6 rounded-3xl shadow-2xl">
            <h2 class="text-2xl font-black text-center mb-6 text-yellow-500 italic uppercase">Clasificaci√≥n</h2>
            <table class="w-full">
                <tbody id="ranking-table"></tbody>
            </table>
            <button onclick="closeRanking()" class="w-full mt-8 bg-white text-black py-4 rounded-2xl font-black uppercase">Siguiente Ronda</button>
        </div>
    </div>

    <div id="online-game-screen" class="hidden h-screen flex flex-col p-4">
        <div id="online-ui" class="flex flex-col h-full">
             <div class="flex justify-between items-start z-[160]">
                <div id="online-scores" class="glass p-3 rounded-xl text-[11px] min-w-[110px] border-l-4 border-yellow-500"></div>
                <div id="trump-slot" class="scale-90"></div>
            </div>
            <div class="table-center" id="board"></div>
            <div class="absolute top-[65%] left-0 w-full text-center z-20"><p id="status-msg" class="text-yellow-400 font-black uppercase text-sm drop-shadow-md"></p></div>
            <div class="mt-auto flex justify-center gap-1 pb-10" id="player-hand"></div>
        </div>
    </div>

    <div id="bet-modal" class="hidden fixed inset-0 z-[150] flex flex-col items-center pt-20">
        <div class="glass p-5 rounded-3xl text-center border-b-4 border-yellow-500 w-[85%] max-w-xs pointer-events-auto">
            <p id="bet-player-name" class="text-yellow-500 text-xs font-bold uppercase"></p>
            <h2 class="text-xl font-black mb-4 italic">¬øCU√ÅNTAS PIDES?</h2>
            <div id="bet-options" class="flex flex-wrap justify-center gap-2"></div>
        </div>
    </div>

    <script>
        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBUXvMwtXc2S_lNghaWOPwvKF5Z7EDB2lQ",
            authDomain: "pochaonline-ebbc1.firebaseapp.com",
            databaseURL: "https://pochaonline-ebbc1-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "pochaonline-ebbc1"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // VARIABLES GLOBALES
        let players = []; let rounds = []; let currentIdx = 0;
        let isBettingPhase = true; let deckSize = 40;
        let myName = ""; let roomRef = null; let gameState = null;
        const emojis = {'OROS': 'üü°', 'COPAS': 'üç∑', 'ESPADAS': '‚öîÔ∏è', 'BASTOS': 'ü™µ'};

        function showScreen(id) {
            document.getElementById('main-menu').classList.add('hidden');
            if(id === 'online-lobby') initOnline();
            else document.getElementById(id).classList.remove('hidden');
        }

        /* --- L√ìGICA MARCADOR BOLO (LOCAL) --- */
        function setDeck(n) {
            deckSize = n;
            document.getElementById('m40').classList.toggle('active-mode', n===40);
            document.getElementById('m36').classList.toggle('active-mode', n===36);
        }

        function addPlayerBolo() {
            const val = document.getElementById('p-name-bolo').value.trim();
            if(val) {
                players.push({ name: val.toUpperCase(), score: 0, bet: 0, lastDiff: 0 });
                document.getElementById('p-name-bolo').value = '';
                renderPlayersBolo();
            }
        }

        function renderPlayersBolo() {
            document.getElementById('p-list-bolo').innerHTML = players.map(p => `<li>üë§ ${p.name}</li>`).join('');
            if(players.length >= 2) document.getElementById('btn-start-bolo').classList.remove('hidden');
        }

        function startGameBolo() {
            const n = players.length; const max = Math.floor(deckSize / n);
            rounds = [];
            for(let i=0; i<n; i++) rounds.push(1);
            for(let i=2; i<max; i++) rounds.push(i);
            for(let i=0; i<n; i++) rounds.push(max);
            for(let i=max-1; i>=2; i--) rounds.push(i);
            for(let i=0; i<n; i++) rounds.push(1);
            
            document.getElementById('score-setup').classList.add('hidden');
            document.getElementById('bolo-game').classList.remove('hidden');
            initPhaseBolo();
        }

        function initPhaseBolo() {
            const container = document.getElementById('b-players-actions');
            document.getElementById('b-round-label').innerText = `RONDA ${currentIdx+1} / ${rounds.length}`;
            document.getElementById('b-cards-label').innerText = `${rounds[currentIdx]} ${rounds[currentIdx] === 1 ? 'CARTA' : 'CARTAS'}`;
            document.getElementById('b-phase-title').innerText = isBettingPhase ? "üîÆ Petici√≥n" : "üÉè Resultado";
            document.getElementById('b-phase-title').className = isBettingPhase ? "text-blue-400 font-bold text-center mb-4 uppercase" : "text-green-400 font-bold text-center mb-4 uppercase";
            
            container.innerHTML = players.map((p, i) => `
                <div class="flex justify-between items-center p-3 border-b border-white/10">
                    <span class="font-bold">${p.name} ${!isBettingPhase ? `<span class="text-[10px] text-blue-400 block">Pidi√≥ ${p.bet}</span>` : ''}</span>
                    <input type="number" id="b-input-${i}" class="w-16 p-2 input-dark text-center font-bold text-xl" oninput="checkBoloRule()" value="0">
                </div>
            `).join('');
            checkBoloRule();
        }

        function checkBoloRule() {
            if(!isBettingPhase) return;
            const n = players.length; const cards = rounds[currentIdx];
            let sum = 0;
            for(let i=0; i<n-1; i++) sum += parseInt(document.getElementById(`b-input-${i}`).value) || 0;
            const forbidden = cards - sum;
            const lastInput = document.getElementById(`b-input-${n-1}`);
            if(forbidden >= 0) {
                document.getElementById('b-rule-warning').classList.remove('hidden');
                document.getElementById('b-forbidden-val').innerText = forbidden;
                const isErr = parseInt(lastInput.value) === forbidden;
                lastInput.style.borderColor = isErr ? 'red' : '#444';
                document.getElementById('b-main-btn').disabled = isErr;
                document.getElementById('b-main-btn').style.opacity = isErr ? "0.3" : "1";
            } else document.getElementById('b-rule-warning').classList.add('hidden');
        }

        function processPhaseBolo() {
            if(isBettingPhase) {
                players.forEach((p, i) => p.bet = parseInt(document.getElementById(`b-input-${i}`).value) || 0);
                isBettingPhase = false;
                initPhaseBolo();
            } else {
                players.forEach((p, i) => {
                    const made = parseInt(document.getElementById(`b-input-${i}`).value) || 0;
                    p.lastDiff = (made === p.bet) ? (10 + (p.bet * 5)) : -5;
                    p.score += p.lastDiff;
                });
                showRanking();
            }
        }

        function showRanking() {
            const table = document.getElementById('ranking-table');
            const sorted = [...players].sort((a,b) => b.score - a.score);
            table.innerHTML = sorted.map((p, idx) => `
                <tr class="border-b border-white/5">
                    <td class="py-3 font-bold text-sm">${idx+1}. ${p.name}</td>
                    <td class="py-3 text-right">
                        <span class="font-mono text-xl">${p.score}</span>
                        <span class="text-[10px] font-bold ${p.lastDiff > 0 ? 'text-green-500' : 'text-red-500'} ml-1">
                            (${p.lastDiff > 0 ? '+' : ''}${p.lastDiff})
                        </span>
                    </td>
                </tr>
            `).join('');
            document.getElementById('ranking-modal').style.display = 'flex';
        }

        function closeRanking() {
            document.getElementById('ranking-modal').style.display = 'none';
            if(currentIdx < rounds.length - 1) {
                currentIdx++;
                isBettingPhase = true;
                initPhaseBolo();
            } else alert("FIN DE PARTIDA");
        }

        /* --- L√ìGICA ONLINE (FIREBASE) --- */
        function initOnline() {
            myName = prompt("TU NOMBRE:").toUpperCase();
            roomCode = prompt("C√ìDIGO SALA:").toUpperCase();
            if(!myName || !roomCode) return location.reload();
            roomRef = db.ref('rooms/' + roomCode);
            roomRef.on('value', snap => { gameState = snap.val(); if(gameState) renderOnline(); });
            roomRef.once('value', snap => {
                let data = snap.val() || { players: [], round: 1, turn: 0, phase: 'LOBBY' };
                if(!data.players.find(p => p.name === myName)) data.players.push({ name: myName, score: 0, bet: -1, made: 0, hand: [] });
                roomRef.set(data);
            });
            document.getElementById('online-game-screen').classList.remove('hidden');
        }

        function renderOnline() {
            const me = gameState.players.find(p => p.name === myName);
            const activeP = gameState.players[gameState.turn];
            if(gameState.phase === 'LOBBY') {
                document.getElementById('status-msg').innerHTML = gameState.players[0].name === myName ? `<button onclick="startOnlineRound()" class="bg-green-600 px-6 py-2 rounded-xl">REPARTIR</button>` : `ESPERANDO...`;
                return;
            }
            // (Resto de la l√≥gica de renderizado online que ya ten√≠amos...)
            document.getElementById('status-msg').innerText = activeP.name === myName ? "TU TURNO" : "TURNO DE " + activeP.name;
        }

        function createCardUI(card) {
            const div = document.createElement('div'); div.className = 'card';
            const val = card.v === 1 ? 'A' : (card.v === 10 ? 'S' : (card.v === 11 ? 'C' : (card.v === 12 ? 'R' : card.v)));
            div.innerHTML = `<div class="text-[10px] self-start">${val}</div><div class="text-3xl">${emojis[card.s]}</div><div class="text-[10px] self-end rotate-180">${val}</div>`;
            return div;
        }
    </script>
</body>
</html>