<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#064e3b">
	<link rel="manifest" href="manifest.json">
    <title>POCHA ULTIMATE PRO</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        html, body { overflow: hidden; height: 100%; width: 100%; margin: 0; position: fixed; background: #064e3b; color: white; }
        body { padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); }
        .glass { background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .card { width: 46px; height: 70px; background: white !important; color: black !important; border-radius: 6px; display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding: 4px; font-weight: 900; font-size: 13px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); border: 1px solid #ccc; transition: transform 0.2s; }
        .table-center { background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 75%); border-radius: 50%; width: 240px; height: 240px; position: absolute; top: 42%; left: 50%; transform: translate(-50%, -50%); border: 1px dashed rgba(255,255,255,0.1); }
        .played-card { position: absolute; left: 50%; top: 50%; margin-left: -23px; margin-top: -35px; z-index: 10; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .card-active { border: 3px solid #fbbf24 !important; transform: translateY(-15px); cursor: pointer; filter: brightness(1.1); }
        .btn-primary { background: #2563eb; transition: all 0.2s; box-shadow: 0 4px 0 #1e40af; }
        .btn-primary:active { transform: translateY(2px); box-shadow: 0 2px 0 #1e40af; }
        #ui-hand::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <div id="screen-login" class="flex flex-col items-center justify-center h-full px-8 text-center space-y-6">
        <div class="animate-pulse mb-4">
            <h1 class="text-6xl font-black text-yellow-500 italic tracking-tighter">POCHA</h1>
            <p class="text-xs tracking-[0.4em] font-bold opacity-60">ULTIMATE EDITION</p>
        </div>
        <div class="glass p-8 rounded-[2.5rem] w-full max-w-sm space-y-4 shadow-2xl">
            <input type="text" id="input-name" placeholder="NOMBRE" class="w-full p-4 bg-zinc-900 border border-zinc-700 rounded-2xl text-white font-bold uppercase text-center focus:border-blue-500">
            <input type="text" id="input-room" placeholder="C√ìDIGO SALA" class="w-full p-4 bg-zinc-900 border border-zinc-700 rounded-2xl text-white font-bold uppercase text-center focus:border-blue-500">
            <button onclick="joinOnline()" class="btn-primary w-full py-5 rounded-2xl font-black text-xl uppercase tracking-tight">Entrar a la mesa</button>
            <button onclick="toggleBolo()" class="w-full text-zinc-500 text-[10px] font-black uppercase tracking-widest">Alternar Marcador BOLO</button>
        </div>
    </div>

    <div id="screen-game" class="hidden h-full flex flex-col p-4 relative overflow-hidden">
        <header class="flex justify-between items-center z-50 mb-2">
            <div class="bg-black/40 px-4 py-2 rounded-2xl border border-white/10 flex items-center gap-3">
                <div class="text-left leading-none">
                    <span class="text-[8px] text-yellow-500 font-black uppercase block">SALA</span>
                    <span id="room-id-display" class="text-lg font-black text-white">---</span>
                </div>
                <button onclick="invitePlayers()" class="bg-white/10 hover:bg-white/20 p-2 rounded-xl border border-white/10 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                </button>
            </div>
            <div id="ui-trump"></div>
        </header>

        <div class="flex-1 relative">
            <div id="ui-scores" class="glass absolute top-0 left-0 p-3 rounded-2xl text-[10px] min-w-[130px] border-l-4 border-yellow-500 z-30 shadow-2xl"></div>
            <div class="table-center" id="ui-board"></div>
            <div class="absolute top-[65%] left-0 w-full text-center z-20">
                <div id="status-text" class="text-yellow-400 font-black uppercase text-[10px] bg-black/80 px-6 py-2 inline-block rounded-full border border-yellow-500/20"></div>
            </div>
        </div>

        <div id="ui-hand" class="flex justify-center gap-1.5 pb-10 overflow-x-auto px-4 min-h-[110px]"></div>
    </div>

    <div id="modal-bet" class="hidden fixed inset-0 z-[200] flex items-center justify-center bg-black/70 backdrop-blur-md px-6">
        <div class="glass p-8 rounded-[2.5rem] text-center w-full max-w-[320px] border-b-8 border-yellow-500 shadow-2xl scale-in">
            <h2 id="bet-title" class="text-2xl font-black mb-6 text-white uppercase italic tracking-tighter">¬øCu√°ntas?</h2>
            <div id="bet-options" class="grid grid-cols-4 gap-3"></div>
            <p id="bet-forbidden-msg" class="text-red-500 text-[10px] font-black mt-6 uppercase hidden bg-red-500/10 py-2 rounded-xl">‚ö†Ô∏è BLOQUEO: NO PUEDES PEDIR <span id="forbidden-val"></span></p>
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN FIREBASE (Mant√©n esta o usa la tuya propia)
        const firebaseConfig = {
            apiKey: "AIzaSyBUXvMwtXc2S_lNghaWOPwvKF5Z7EDB2lQ",
            authDomain: "pochaonline-ebbc1.firebaseapp.com",
            databaseURL: "https://pochaonline-ebbc1-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "pochaonline-ebbc1"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myName = localStorage.getItem('pocha_name') || "";
        if(myName) document.getElementById('input-name').value = myName;

        let roomCode = ""; let roomRef = null; let gameState = null;
        let isLocked = false;
        const emojis = {'OROS': 'üü°', 'COPAS': 'üç∑', 'ESPADAS': '‚öîÔ∏è', 'BASTOS': 'ü™µ'};

        function showScreen(id) {
            document.querySelectorAll('body > div').forEach(div => div.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        async function joinOnline() {
            const nameInput = document.getElementById('input-name').value.trim().toUpperCase();
            roomCode = document.getElementById('input-room').value.trim().toUpperCase();
            
            if(!nameInput || !roomCode) return alert("Rellena nombre y sala");
            
            myName = nameInput;
            localStorage.setItem('pocha_name', myName);
            document.getElementById('room-id-display').innerText = roomCode;
            
            roomRef = db.ref('rooms/' + roomCode);
            roomRef.on('value', snap => {
                gameState = snap.val();
                if(gameState) renderGame();
            });

            const snap = await roomRef.get();
            let data = snap.val() || { players: [], roundIdx: 0, turn: 0, phase: 'LOBBY' };
            
            // Si el jugador no existe, lo a√±adimos
            if(!data.players.find(p => p.name === myName)) {
                if(data.phase !== 'LOBBY') return alert("Partida en curso");
                data.players.push({ name: myName, score: 0, bet: -1, made: 0, hand: [], played: "" });
                await roomRef.set(data);
            }
            
            showScreen('screen-game');
        }

        function invitePlayers() {
            const text = `¬°Vente a la Pocha! Sala: ${roomCode}\n${window.location.href}`;
            if(navigator.share) navigator.share({ title: 'Pocha Pro', text: text });
            else { navigator.clipboard.writeText(text); alert("Link copiado"); }
        }

        function renderGame() {
            const me = gameState.players.find(p => p.name === myName);
            const activeP = gameState.players[gameState.turn];
            const isMyTurn = (activeP && activeP.name === myName);
            const cardsInRound = getSequence(gameState.players.length)[gameState.roundIdx] || 1;

            // Marcador
            document.getElementById('ui-scores').innerHTML = gameState.players.map(p => 
                `<div class="flex justify-between font-bold ${activeP?.name === p.name ? 'text-yellow-400' : 'text-zinc-400'}">
                    <span>${p.name}</span>
                    <span>${p.score} <small class="opacity-50">[${p.made}/${p.bet < 0 ? '?' : p.bet}]</small></span>
                </div>`).join('');

            // Triunfo
            document.getElementById('ui-trump').innerHTML = gameState.trump ? createCardHTML(gameState.trump) : '';

            // Mesa (C√≠rculo)
            document.getElementById('ui-board').innerHTML = gameState.players.map((p, i) => {
                if(!p.played) return '';
                const angle = i * (360 / gameState.players.length);
                return `<div class="played-card" style="transform: rotate(${angle}deg) translateY(-85px) rotate(-${angle}deg)">${createCardHTML(p.played)}</div>`;
            }).join('');

            // Mano + L√≥gica de Arrastre
            const handDiv = document.getElementById('ui-hand');
            handDiv.innerHTML = "";
            if(me && me.hand) {
                // Comprobamos si el jugador tiene cartas del palo de salida
                const hasSuit = me.hand.some(c => c.s === gameState.firstSuit);
                
                me.hand.forEach((c, i) => {
                    const el = document.createElement('div');
                    el.innerHTML = createCardHTML(c);
                    const cardBtn = el.firstChild;
                    
                    if(isMyTurn && gameState.phase === 'PLAYING') {
                        // REGLA: Obligado a asistir al palo si tienes
                        const canPlay = !gameState.firstSuit || c.s === gameState.firstSuit || !hasSuit;
                        
                        if(canPlay) {
                            cardBtn.classList.add('card-active');
                            cardBtn.onclick = () => playCard(i);
                        } else {
                            cardBtn.style.opacity = "0.3";
                            cardBtn.style.filter = "grayscale(1)";
                        }
                    }
                    handDiv.appendChild(cardBtn);
                });
            }

            // Modal Apuestas
            const modal = document.getElementById('modal-bet');
            if(gameState.phase === 'BETTING') {
                modal.classList.remove('hidden');
                document.getElementById('bet-title').innerText = isMyTurn ? "TU APUESTA" : "ESPERANDO...";
                const opts = document.getElementById('bet-options'); opts.innerHTML = "";
                
                if(isMyTurn) {
                    const playersBetting = gameState.players.filter(p => p.bet !== -1).length;
                    const sum = gameState.players.reduce((a, b) => a + (b.bet === -1 ? 0 : b.bet), 0);
                    const forbidden = (playersBetting === gameState.players.length - 1) ? (cardsInRound - sum) : -1;

                    document.getElementById('bet-forbidden-msg').classList.toggle('hidden', forbidden < 0 || forbidden > cardsInRound);
                    if(forbidden >= 0) document.getElementById('forbidden-val').innerText = forbidden;

                    for(let i=0; i <= cardsInRound; i++) {
                        const btn = document.createElement('button');
                        const isF = (i === forbidden);
                        btn.className = `p-4 rounded-2xl font-black text-xl transition-all ${isF ? 'bg-zinc-800 text-zinc-600 opacity-40' : 'bg-yellow-500 text-black shadow-lg active:scale-90'}`;
                        btn.innerText = i; btn.disabled = isF;
                        btn.onclick = () => submitBet(i);
                        opts.appendChild(btn);
                    }
                }
            } else modal.classList.add('hidden');

            // Estado Inferior
            const st = document.getElementById('status-text');
            if(gameState.phase === 'LOBBY') {
                const isHost = gameState.players[0].name === myName;
                st.innerHTML = isHost ? `<button onclick="deal()" class="px-8 py-2 font-black">REPARTIR ${cardsInRound}</button>` : "ESPERANDO AL L√çDER";
            } else {
                st.innerText = isMyTurn ? "TU TURNO" : "TURNO DE " + (activeP ? activeP.name : "...");
            }
        }

        async function submitBet(n) {
            if(isLocked) return; isLocked = true;
            gameState.players[gameState.turn].bet = n;
            gameState.turn = (gameState.turn + 1) % gameState.players.length;
            if(gameState.players.every(p => p.bet !== -1)) { gameState.phase = 'PLAYING'; gameState.firstSuit = ""; }
            await roomRef.set(gameState);
            isLocked = false;
        }

        async function playCard(idx) {
            if(isLocked) return; isLocked = true;
            const pIdx = gameState.players.findIndex(p => p.name === myName);
            const card = gameState.players[pIdx].hand.splice(idx, 1)[0];
            gameState.players[pIdx].played = card;
            
            if(!gameState.firstSuit) gameState.firstSuit = card.s;
            gameState.cardsPlayed = (gameState.cardsPlayed || 0) + 1;

            if(gameState.cardsPlayed === gameState.players.length) {
                await roomRef.set(gameState);
                setTimeout(resolveBaza, 2500);
            } else {
                gameState.turn = (gameState.turn + 1) % gameState.players.length;
                await roomRef.set(gameState);
                isLocked = false;
            }
        }

        async function resolveBaza() {
            let winner = 0; let topPwr = -1;
            gameState.players.forEach((p, i) => {
                let val = p.played.v;
                if(val === 1) val = 20; if(val === 3) val = 15;
                let power = (p.played.s === gameState.trump.s) ? val + 100 : (p.played.s === gameState.firstSuit ? val : 0);
                if(power > topPwr) { topPwr = power; winner = i; }
            });

            gameState.players[winner].made++;
            gameState.players.forEach(p => p.played = "");
            gameState.turn = winner; gameState.firstSuit = ""; gameState.cardsPlayed = 0;

            if(gameState.players[0].hand.length === 0) {
                // Fin de ronda: Calcular puntos
                gameState.players.forEach(p => {
                    if(p.bet === p.made) p.score += (10 + p.made * 5);
                    else p.score -= 5;
                });
                gameState.roundIdx++;
                gameState.phase = 'LOBBY';
            }
            await roomRef.set(gameState);
            isLocked = false;
        }

        async function deal() {
            const seq = getSequence(gameState.players.length);
            const n = seq[gameState.roundIdx];
            const deck = [];
            ['OROS','COPAS','ESPADAS','BASTOS'].forEach(s => [1,2,3,4,5,6,7,10,11,12].forEach(v => deck.push({s,v})));
            deck.sort(() => Math.random() - 0.5);

            gameState.players.forEach(p => {
                p.hand = deck.splice(0, n);
                p.bet = -1; p.made = 0; p.played = "";
            });
            gameState.trump = deck.pop();
            gameState.phase = 'BETTING';
            gameState.turn = (gameState.roundIdx) % gameState.players.length; // El turno rota cada ronda
            await roomRef.set(gameState);
        }

        function getSequence(nP) {
            let s = []; const max = Math.floor(40/nP);
            for(let i=0;i<nP;i++) s.push(1); for(let i=2;i<max;i++) s.push(i);
            for(let i=0;i<nP;i++) s.push(max); for(let i=max-1;i>=2;i--) s.push(i);
            for(let i=0;i<nP;i++) s.push(1); return s;
        }

        function createCardHTML(c) {
            const val = c.v === 1 ? 'A' : (c.v === 10 ? 'S' : (c.v === 11 ? 'C' : (c.v === 12 ? 'R' : c.v)));
            return `<div class="card"><div>${val}</div><div class="text-xl">${emojis[c.s]}</div><div class="rotate-180">${val}</div></div>`;
        }

        function toggleBolo() { alert("Para usar el BOLO de forma aislada, abre el c√≥digo anterior del marcador."); }
    </script>
</body>
</html>